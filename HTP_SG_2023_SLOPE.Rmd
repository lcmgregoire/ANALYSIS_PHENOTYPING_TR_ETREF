---
title: "Analysis Tr-ETref LTP Sorghum 2024"
author: "Laura Gregoire"
date: "`r Sys.Date()`"
output:
  pdf_document:
    latex_engine: xelatex
---
### FROM KAR ET AL PIPELINE, WE HAVE TR SMOOTH NORMALIZED BY LA and TR non nomalized 
 **MAIN QUESTION : Do the slope of TR rate - ETRef measured by Leasyscan platform differ among genotypes? what heritability ? **



OBJECTIVES : 
**we want to draw the relation TRrate - ETREF (measured by Leasyscan every 15min)**
- how to do it ? We want to compare with another manual experiment. So we will adapt the Leasyscan data to this previous experiment. (Description above)
- relation TRrate-ETRef : what is the best model to represent it ? (linear, affine, polynomial, breakpoint?)
- with the best model, extract the slope value of the regression TRrate- ETref
- distribution, anova slope-genotype, and heritability calculation : is it an interesting trait for GWAS?


- import the data of the previous experiment
- Leasyscan : 4 sorghum plants per plot// Thies experiment 1 plant per plot. we suppose that we work with the Leasyscan data in canopy, and in the previous experiment with individual plant : do we see a correlation between slope value ?
- Leasyscan data measured on 14 days (21 days,  less irrigation) : compare the start and end of experiment; before and after canopy closure. Do we see a correlation



The compared experiment = Thies experiment
- manual measurement in Thies, Sénégal, in February 2024
- individual plants in pots 10L 
- measured from 56- 60 DAS (4 days of measurements)
- measured at fixed hours 8Ham 12Ham, 3Hpm 5H30pm
- sandy soil


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(repos = c(CRAN = "https://cran.r-project.org"))
tinytex::is_tinytex()
rm(list = ls())
```

```{r wd librairies}

library(ggplot2)
library(car)
library(ggpubr)
library(segmented)
library(pastecs)
library(dplyr)
library(patchwork)
library(RLRsim)
library(lme4)
library(inti)
library(lubridate)
library(tidyr)
library(purrr)
library(Metrics) # RMSE
library(tibble)
library(ggrepel)


library("lubridate")
library("hms")
library("dplyr")
library("stringr")
library("data.table")
library("zoo")
library("soiltestcorr")

## libraries Kar et al
library(SpATS)
library(reshape2)       
library("tidyr")
library(tidyr)     # data management
library(nlme)      # nonlinear model
library(locfit)    # local regression
library(gss)       # smoothing splines
library(factoextra)       
library(gridExtra)       
library(mgcv)
library(magick)
library(segmented)
library(MASS)
library(tidyverse)
library(rstatix)
library(statgenSTA)


check_if_present <- function(condition, liste) {
    # Vérifier si la condition est présente dans la liste
    if (any(condition %in% liste)) {
        return(TRUE)
    } else {
        return(FALSE)
    }
}


here::here()

opPATH.obj= "./saved_objects/"
  if (!dir.exists(opPATH.obj)) dir.create(opPATH.obj, recursive = TRUE)


opPATH.results= "./results/"
  if (!dir.exists(opPATH.results)) dir.create(opPATH.results, recursive = TRUE)


opPATH.data= "./data/"
  if (!dir.exists(opPATH.data)) dir.create(opPATH.data, recursive = TRUE)


opPATH.fig= "./figures/"
  if (!dir.exists(opPATH.fig)) dir.create(opPATH.fig, recursive = TRUE)

trait_name = "SLOPE"
trial = "HTP_SG_2023"

```

we have TR rate on 15 minutes intervals from Kar et al pipeline ouputs. We want to have the sum of transpiration over periods as the compared experiment : 
8h-12h, 12h-15h, 15h-17h30, and 17h30-8h

```{r TRrate in periods  }
#load metadata previously acquired in KAr et al pipeline (TS , LC, genotype info) 
# load('./TS.RData')
load(paste0(opPATH.data,"LC.RData") )
geno_info = read.csv(paste0(opPATH.data,"METADATA_HTP_SG_2023.csv"), sep = ";", header = TRUE)
geno_info$Variety_ID = as.factor(geno_info$Variety_ID)
# geno_info$geno_trt = str_replace_all(geno_info$geno_trt, "/\| WW_R","..WW_R")
seq_by=15 ## define as parameter in Kar et al. 
irrg.dts <- c("2023-09-30","2023-10-03","2023-10-06", "2023-10-10", "2023-10-13", "2023-10-17", "2023-10-18") ## remove irrigation days





# load transpiration rate data on 15 minute interval
# inputfile_TR<-read.csv(paste0(opPATH.data,"TR.mat_updated.csv"), sep = ";", header = TRUE)  #draw raw TR smooth normalized by leaf area  
inputfile_TRrate<-read.csv(paste0(opPATH.data,"DATA_TR_RATE_HTP_SG_2023.csv"), sep = ";", header = TRUE)  #draw raw TR smooth normalized by leaf area  

inputfile_TRrate= inputfile_TRrate[,-1] ## removed the unit column
TS = colnames(inputfile_TRrate)
TS = gsub("X", "", TS)
TS = dmy_hm(TS)

colnames(inputfile_TRrate) = TS
LC = as.data.frame(LC)
colnames(LC)= "unit"


## create a working dataset names data (and used the inputfie_TRrate as saved)
data = as.data.frame(t(inputfile_TRrate))
colnames(data)=LC[,1]

# Convert to POSIXct
Hour = as.POSIXct(TS) 
Hour = as.character(Hour)

Hour_fixed <- ifelse(
  nchar(Hour) == 10,               # if it's just "YYYY-MM-DD"
  paste(Hour, "00:00:00"),         # add time
  Hour                             # otherwise leave as-is
)
Hour <- Hour_fixed  # e.g. "2023-10-12 08:15:00"
Hour <- as.POSIXct(Hour, format = "%Y-%m-%d %H:%M:%S")
Hour_only <- format(Hour, "%H:%M:%S")
Hour = as.data.frame(Hour_only)


Date = as.data.frame(as.Date(TS)) 
TS= as.data.frame(TS)
nrow(Hour)
nrow(data)
nrow(Date)
nrow(TS)


data= cbind(TS, Date, Hour, data)
colnames(data)= c("TS", "Date", "Hour",LC[,1])

## create an empty dataset to store all the sum of TRrateanspiration
TRrate_entire_exp <- as.data.frame(matrix(NA, nrow = 5*length(unique(data$Date)), ncol = length(colnames(data))))
  colnames(TRrate_entire_exp)= colnames(data)
  TRrate_entire_exp$day = NA
  a=1
  b=5

unq.dts = unique(data$Date)
unq.dts = na.omit(unq.dts)


## sum of TRraterateanspiration over periods 
for (d in 1:length(unique(data$Date))){
  TRrate_period <- as.data.frame(matrix(NA, nrow = 5, ncol = length(colnames(data))))
  colnames(TRrate_period)= colnames(data)
  ## definition of time period
  colnames(TRrate_period)[2]= "start"
  colnames(TRrate_period)[3]= "end"
  TRrate_period$start = c(0, 8,12,15,17.5)
  TRrate_period$end = c(8,12,15,17.5,24)
  TRrate_period$TS = c(0,1,2,3,4)
  subset= data[data$Date == unq.dts[d],]### pick a day
  subset= as.data.frame(subset)
  # subset = na.omit(subset)
  #period 0 from 0h to 8h
    start_interval0 ="00:00:00"
    end_interval0 ="08:00:00" 
    line_start0 =  which(subset$Hour %in% start_interval0)     
    line_end0 =  which(subset$Hour %in% end_interval0)     
    
    for (j in 4:ncol(subset)){ ## ncol 1:TS, 2:Date, 2:Hour
   sum_0_8= sum(subset[c(line_start0:line_end0),j])
   TRrate_period[1,j]=    sum_0_8
    }
    
    #period 1 from 8h to 12h
    start_interval1 ="08:00:00"
    end_interval1 ="12:00:00" 
    line_start1 =  which(subset$Hour %in% start_interval1)     
    line_end1 =  which(subset$Hour %in% end_interval1)     
    
    for (j in 4:ncol(subset)){
   sum_8_12= sum(subset[c(line_start1:line_end1),j])
   TRrate_period[2,j]=    sum_8_12
    }
    
    #period 2 from 12am to 15
    start_interval2 ="12:00:00"
    end_interval2 ="15:00:00" 
    line_start2 =  which(subset$Hour %in% start_interval2)     
    line_end2 =  which(subset$Hour %in% end_interval2)  
    
     for (j in 4:ncol(subset)){
   sum_12_15= sum(subset[c(line_start2:line_end2),j])
   TRrate_period[3,j]=    sum_12_15
    }
    
    #period 3 from 15 to 17h30
    start_interval3 ="15:00:00" 
    end_interval3 ="17:30:00" 
    line_start3 =  which(subset$Hour %in% start_interval3)     
    line_end3 =  which(subset$Hour %in% end_interval3)  
    
   for (j in 4:ncol(subset)){
   sum_15_1730= sum(subset[c(line_start3:line_end3),j])
   TRrate_period[4,j]=    sum_15_1730
   }
    
    #period 4 from 17h30 to 23h59
    start_interval4 ="17:30:00" 
    end_interval4 ="23:45:00" 
    line_start4 =  which(subset$Hour %in% start_interval4)     
    line_end4 =  which(subset$Hour %in% end_interval4)  
    
   for (j in 4:ncol(subset)){
   sum_1730_0= sum(subset[c(line_start4:line_end4),j])
   TRrate_period[5,j]=    sum_1730_0
   }

  TRrate_entire_exp[a:b,] = TRrate_period
 
  TRrate_entire_exp$day[a:b]= d
  a=a+5
  b=b+5
  
}

 colnames(TRrate_entire_exp)[1] = "period"
  colnames(TRrate_entire_exp)[2] = "start"
  colnames(TRrate_entire_exp)[3] = "end"
  colnames(TRrate_entire_exp)[ncol(TRrate_entire_exp)] = "n_day"
TRrate_entire_exp=relocate(TRrate_entire_exp, n_day)



TRrate_entire_exp = TRrate_entire_exp[-1,]##remove the first line midnight-8 a.m. on the first day (not measured in the manual experiment)
TRrate_entire_exp =TRrate_entire_exp[-nrow(TRrate_entire_exp),]#remove the last line 5h30pm to mid-night, last day (not measured in the manual experiment)


#sum the midnight-8am and 5:30pm-midnight periods from one day to the next
TRrate_entire_exp$period [TRrate_entire_exp$period  == 0] <- 4 

  for (i in 1:(nrow(TRrate_entire_exp)-1)){
  if (TRrate_entire_exp$period[i] == TRrate_entire_exp$period[i+1] & !is.na(TRrate_entire_exp$period[i+1])) {

     for (j in 5:ncol(TRrate_entire_exp)){
            TRrate_entire_exp[i,j]  =  sum(TRrate_entire_exp[i,j],TRrate_entire_exp[i+1,j])
    }
    TRrate_entire_exp = TRrate_entire_exp[-(i+1),]
  } 
  }

# TRraterate is expressed as the TRraterate on the entire period But the duration of the period is different. Need to divide by the duration of the period
TRrate_entire_exp$duration=NA

  for (i in 1:nrow(TRrate_entire_exp)){
    TRrate_entire_exp$duration[i]  = TRrate_entire_exp$end[i]-TRrate_entire_exp$start[i]
  }
  
TRrate_entire_exp$duration [TRrate_entire_exp$duration  == 6.5] <- 14.5 ## period from 17h30 to 00h00 and 00h00 to 8h



  for (i in 1:nrow(TRrate_entire_exp)){
    for (j in 5:ncol(TRrate_entire_exp)-1){
    TRrate_entire_exp[i,j]  = TRrate_entire_exp[i,j]/TRrate_entire_exp$duration[i]
  }}
## the TRrate value is now expressed on mm.h-1.m-²

#change colnames of TRrate dataset to have the genotype/TRrateeatment information, instead of the unit
# header <- left_join(LC, geno_info, by = "unit")  
# header <- header[!duplicated(header$unit), ]
# # header$geno_TRratet = as.character(header$geno_TRratet)
# # header$geno_TRratet = sTRrate_replace_all(header$geno_TRratet, "\\| WW_R", "..WW_R")
# # header = rbind( "n_day",     "period"  ,  "start"  ,   "end", header)
# 
# colnames(TRrate_entire_exp) = header$GENO_TRrateT
save(TRrate_entire_exp, file = paste0(opPATH.obj, "DATA_TR_RATE",trial,".RData"))
load(file = paste0(opPATH.obj, "DATA_TR_RATE",trial,".RData"))


```


```{r TR INTERVAL in periods  }
#load metadata previously acquired in KAr et al pipeline (TS , LC, genotype info) 
# load('./TS.RData')
load(paste0(opPATH.data,"LC.RData") )
geno_info = read.csv(paste0(opPATH.data,"METADATA_HTP_SG_2023.csv"), sep = ";", header = TRUE)
geno_info$Variety_ID = as.factor(geno_info$Variety_ID)
# geno_info$geno_trt = str_replace_all(geno_info$geno_trt, "/\| WW_R","..WW_R")
seq_by=15 ## define as parameter in Kar et al. 
irrg.dts <- c("2023-09-30","2023-10-03","2023-10-06", "2023-10-10", "2023-10-13", "2023-10-17", "2023-10-18") ## remove irrigation days

# load transpiration rate data on 15 minute interval
# inputfile_TR<-read.csv(paste0(opPATH.data,"TR.mat_updated.csv"), sep = ";", header = TRUE)  #draw raw TR smooth normalized by leaf area  
inputfile_TR_G_INTERVAL<-read.csv(paste0(opPATH.data,"ETr_non_normalized_HTP_SG_2023.csv"), sep = ";", header = TRUE)  #draw raw TR smooth normalized by leaf area  

inputfile_TR_G_INTERVAL= inputfile_TR_G_INTERVAL[,-1] ## removed the unit column
TS = colnames(inputfile_TR_G_INTERVAL)
TS = gsub("X", "", TS)
TS = dmy_hm(TS)

colnames(inputfile_TR_G_INTERVAL) = TS
LC = as.data.frame(LC)
colnames(LC)= "unit"


## create a working dataset names data (and used the inputfie_TR as saved)
data = as.data.frame(t(inputfile_TR_G_INTERVAL))
colnames(data)=LC[,1]

# Convert to POSIXct
Hour = as.POSIXct(TS) 
Hour = as.character(Hour)

Hour_fixed <- ifelse(
  nchar(Hour) == 10,               # if it's just "YYYY-MM-DD"
  paste(Hour, "00:00:00"),         # add time
  Hour                             # otherwise leave as-is
)
Hour <- Hour_fixed  # e.g. "2023-10-12 08:15:00"
Hour <- as.POSIXct(Hour, format = "%Y-%m-%d %H:%M:%S")
Hour_only <- format(Hour, "%H:%M:%S")
Hour = as.data.frame(Hour_only)


Date = as.data.frame(as.Date(TS)) 
TS= as.data.frame(TS)
nrow(Hour)
nrow(data)
nrow(Date)
nrow(TS)


data= cbind(TS, Date, Hour, data)
colnames(data)= c("TS", "Date", "Hour",LC[,1])

## create an empty dataset to store all the sum of transpiration
TR_entire_exp <- as.data.frame(matrix(NA, nrow = 5*length(unique(data$Date)), ncol = length(colnames(data))))
  colnames(TR_entire_exp)= colnames(data)
  TR_entire_exp$day = NA
  a=1
  b=5

unq.dts = unique(data$Date)
unq.dts = na.omit(unq.dts)


## sum of transpiration over periods 
for (d in 1:length(unique(data$Date))){
  TR_period <- as.data.frame(matrix(NA, nrow = 5, ncol = length(colnames(data))))
  colnames(TR_period)= colnames(data)
  ## definition of time period
  colnames(TR_period)[2]= "start"
  colnames(TR_period)[3]= "end"
  TR_period$start = c(0, 8,12,15,17.5)
  TR_period$end = c(8,12,15,17.5,24)
  TR_period$TS = c(0,1,2,3,4)
  subset= data[data$Date == unq.dts[d],]### pick a day
  subset= as.data.frame(subset)
  # subset = na.omit(subset)
  #period 0 from 0h to 8h
    start_interval0 ="00:00:00"
    end_interval0 ="08:00:00" 
    line_start0 =  which(subset$Hour %in% start_interval0)     
    line_end0 =  which(subset$Hour %in% end_interval0)     
    
    for (j in 4:ncol(subset)){ ## ncol 1:TS, 2:Date, 2:Hour
   sum_0_8= sum(subset[c(line_start0:line_end0),j])
   TR_period[1,j]=    sum_0_8
    }
    
    #period 1 from 8h to 12h
    start_interval1 ="08:00:00"
    end_interval1 ="12:00:00" 
    line_start1 =  which(subset$Hour %in% start_interval1)     
    line_end1 =  which(subset$Hour %in% end_interval1)     
    
    for (j in 4:ncol(subset)){
   sum_8_12= sum(subset[c(line_start1:line_end1),j])
   TR_period[2,j]=    sum_8_12
    }
    
    #period 2 from 12am to 15
    start_interval2 ="12:00:00"
    end_interval2 ="15:00:00" 
    line_start2 =  which(subset$Hour %in% start_interval2)     
    line_end2 =  which(subset$Hour %in% end_interval2)  
    
     for (j in 4:ncol(subset)){
   sum_12_15= sum(subset[c(line_start2:line_end2),j])
   TR_period[3,j]=    sum_12_15
    }
    
    #period 3 from 15 to 17h30
    start_interval3 ="15:00:00" 
    end_interval3 ="17:30:00" 
    line_start3 =  which(subset$Hour %in% start_interval3)     
    line_end3 =  which(subset$Hour %in% end_interval3)  
    
   for (j in 4:ncol(subset)){
   sum_15_1730= sum(subset[c(line_start3:line_end3),j])
   TR_period[4,j]=    sum_15_1730
   }
    
    #period 4 from 17h30 to 23h59
    start_interval4 ="17:30:00" 
    end_interval4 ="23:45:00" 
    line_start4 =  which(subset$Hour %in% start_interval4)     
    line_end4 =  which(subset$Hour %in% end_interval4)  
    
   for (j in 4:ncol(subset)){
   sum_1730_0= sum(subset[c(line_start4:line_end4),j])
   TR_period[5,j]=    sum_1730_0
   }

  TR_entire_exp[a:b,] = TR_period
 
  TR_entire_exp$day[a:b]= d
  a=a+5
  b=b+5
  
}

 colnames(TR_entire_exp)[1] = "period"
  colnames(TR_entire_exp)[2] = "start"
  colnames(TR_entire_exp)[3] = "end"
  colnames(TR_entire_exp)[ncol(TR_entire_exp)] = "n_day"
TR_entire_exp=relocate(TR_entire_exp, n_day)



TR_entire_exp = TR_entire_exp[-1,]##remove the first line midnight-8 a.m. on the first day (not measured in the manual experiment)
TR_entire_exp =TR_entire_exp[-nrow(TR_entire_exp),]#remove the last line 5h30pm to mid-night, last day (not measured in the manual experiment)


#sum the midnight-8am and 5:30pm-midnight periods from one day to the next
TR_entire_exp$period [TR_entire_exp$period  == 0] <- 4 

  for (i in 1:(nrow(TR_entire_exp)-1)){
  if (TR_entire_exp$period[i] == TR_entire_exp$period[i+1] & !is.na(TR_entire_exp$period[i+1])) {

     for (j in 5:ncol(TR_entire_exp)){
            TR_entire_exp[i,j]  =  sum(TR_entire_exp[i,j],TR_entire_exp[i+1,j])
    }
    TR_entire_exp = TR_entire_exp[-(i+1),]
  } 
  }

# TRrate is expressed as the TRrate on the entire period But the duration of the period is different. Need to divide by the duration of the period
TR_entire_exp$duration=NA

  for (i in 1:nrow(TR_entire_exp)){
    TR_entire_exp$duration[i]  = TR_entire_exp$end[i]-TR_entire_exp$start[i]
  }
  
TR_entire_exp$duration [TR_entire_exp$duration  == 6.5] <- 14.5 ## period from 17h30 to 00h00 and 00h00 to 8h



  for (i in 1:nrow(TR_entire_exp)){
    for (j in 5:ncol(TR_entire_exp)-1){
    TR_entire_exp[i,j]  = TR_entire_exp[i,j]/TR_entire_exp$duration[i]
  }}
## the TR value is now expressed on mm.h-1.m-²

#change colnames of TR dataset to have the genotype/treatment information, instead of the unit
# header <- left_join(LC, geno_info, by = "unit")  
# header <- header[!duplicated(header$unit), ]
# # header$geno_trt = as.character(header$geno_trt)
# # header$geno_trt = str_replace_all(header$geno_trt, "\\| WW_R", "..WW_R")
# # header = rbind( "n_day",     "period"  ,  "start"  ,   "end", header)
# 
# colnames(TR_entire_exp) = header$GENO_TRT

save(TR_entire_exp, file = paste0(opPATH.obj, "DATA_TR_",trial,".RData"))
load(file = paste0(opPATH.obj, "DATA_TR_",trial,".RData"))

```

We have now TRrate expressed in mm.h-1.m-2, over the period of 8h12h, ... 

Let's do the same for the ETref values. We cannot used directly the ETref values calculated by Kar et al pipeline, because ETref need to used the mean of temperatures, relative humidity and wind speed over the period, but the SUM of SOLAR RADIATION  on the period. It is easier to come back to the raw data : 


```{r}
ETREF <- read.csv(here::here(opPATH.data, "DATA_ETREF_HTP_SG_2023.csv"), dec = ".", sep = ";")

TRrate_entire_exp <- cbind(N = seq_len(nrow(TRrate_entire_exp)), TRrate_entire_exp)
TR_entire_exp <- cbind(N = seq_len(nrow(TR_entire_exp)), TR_entire_exp)

data_TRrate <- merge(
  TRrate_entire_exp,
  ETREF,
  by = "N"
)

data_TR <- merge(
  TR_entire_exp,
  ETREF,
  by = "N"
)


cols_ETREF <- setdiff(colnames(ETREF), "N")
data_TRrate <- data_TRrate[, c("N", cols_ETREF, setdiff(colnames(data_TRrate), c("N", cols_ETREF)))]
data_TR <- data_TR[, c("N", cols_ETREF, setdiff(colnames(data_TR), c("N", cols_ETREF)))]

 data_TRrate <- data_TRrate[, !colnames(data_TRrate) %in% c(    "n_day"  ,   "period"  ,  "start"  ,   "end")]
 data_TR <- data_TR[, !colnames(data_TR) %in% c(    "n_day"  ,   "period"  ,  "start"  ,   "end")]


data_TRrate <- data_TRrate %>%
  pivot_longer(
    cols = -c("N" ,"INTERVAL", "Date",  "START_DAY", "END_DAY", "START_HOUR","END_HOUR","START_DAS", "END_DAS", "DURATION_H","CUMUL_WATER_MM_INTERVAL", "ETREF_MM_H","MEAN_VPD", "KC"         
),  # colonnes à garder
    names_to = "unit",
    values_to = "TR_RATE"
  )
 


data_TR <- data_TR %>%
  pivot_longer(
    cols = -c("N" ,"INTERVAL", "Date",  "START_DAY", "END_DAY", "START_HOUR","END_HOUR","START_DAS", "END_DAS", "DURATION_H","CUMUL_WATER_MM_INTERVAL", "ETREF_MM_H","MEAN_VPD", "KC"         
),  # colonnes à garder
    names_to = "unit",
    values_to = "TR_G_H"
  )

save(data_TR, file = paste0(opPATH.obj, "data_TR_",trial,".RData"))
save(data_TRrate, file = paste0(opPATH.obj, "data_TRrate_",trial,".RData"))


load(file = paste0(opPATH.obj, "data_TR_",trial,".RData"))
load(file = paste0(opPATH.obj, "data_TRrate_",trial,".RData"))

```


```{r}
## add metadata

data_TRrate <- merge(
  data_TRrate,
  geno_info,  # adapte les noms
  by = "unit",
  all.x = TRUE
)



data_TR <- merge(
  data_TR,
  geno_info,  # adapte les noms
  by = "unit",
  all.x = TRUE
)



```


```{r}
# Id unique by interval and geno_trt


## N_GENO

data_TRrate <- data_TRrate %>%
  mutate(N_GENO = str_extract(Variety_ID, "(?<=_)[^_]+(?=_)"))


data_TR <- data_TR %>%
  mutate(N_GENO = str_extract(Variety_ID, "(?<=_)[^_]+(?=_)"))


data_TRrate$GENO_TRT= paste0(data_TRrate$N_GENO, "_", data_TRrate$REPETITION)
data_TR$GENO_TRT= paste0(data_TR$N_GENO, "_", data_TR$REPETITION)

data_TRrate$ID_INTERVAL= paste0(data_TRrate$N, "_", data_TRrate$GENO_TRT)
data_TR$ID_INTERVAL= paste0(data_TR$N, "_", data_TR$GENO_TRT)



```




```{r}
# merge TR and TRrate datasets

data <- data_TR %>%
  left_join(
    data_TRrate %>% select(ID_INTERVAL, TR_RATE),
    by = "ID_INTERVAL"
  )


data <- unique(data)


```

```{r}
## come back to the name that are used in other trials
colnames(data)[colnames(data) == "ETREF_MM_H"] <- "ETREF"
colnames(data)[colnames(data) == "Column"] <- "COLUMN"
colnames(data)[colnames(data) == "Row"] <- "ROW"

```


```{r}
# GENO_NAME
data <- data %>%
  mutate(
    GENO_NAME = str_extract(Variety_ID, "[^_]+$")
  )

```


```{r ETREF KC }

data$ETREF = as.numeric(data$ETREF)
data$KC = as.numeric(data$KC)
data$ETREF_KC = data$ETREF * data$KC
transp= data
```


```{r}

transp$N_GENO=as.factor(transp$N_GENO)
transp$REPETITION=as.factor(transp$REPETITION) 
transp$BLOCK=as.factor(transp$BLOCK)
transp$GENO_TRT=as.factor(transp$GENO_TRT)
transp$ROW=as.factor(transp$ROW)
transp$COLUMN=as.factor(transp$COLUMN)


nlevels(transp$N_GENO)
nlevels(transp$REPETITION)
nlevels(transp$BLOCK)
nlevels(transp$ROW)
nlevels(transp$COLUMN)
save_before_cleaning = transp

```


### data visualisation TR_RATE 

variability among repetitions/block before cleaning : 

```{r visu TR before cleaning }

ggplot(transp, aes(x= transp$BLOCK, y=transp$TR_RATE)) + 
  geom_boxplot() 


ggplot(transp, aes(x= transp$REPETITION, y=transp$TR_RATE)) + 
  geom_boxplot()


ggplot(transp, aes(x= transp$ROW, y=transp$TR_RATE)) + 
  geom_boxplot()


ggplot(transp, aes(x= transp$COLUMN, y=transp$TR_RATE)) + 
  geom_boxplot()



ggplot(transp, aes(x= transp$BLOCK, y=transp$TR_G_H)) + 
  geom_boxplot() 


ggplot(transp, aes(x= transp$REPETITION, y=transp$TR_G_H)) + 
  geom_boxplot()


ggplot(transp, aes(x= transp$ROW, y=transp$TR_G_H)) + 
  geom_boxplot()


ggplot(transp, aes(x= transp$COLUMN, y=transp$TR_G_H)) + 
  geom_boxplot()



```


mean, max, by period, histo  ... removed outliers if necessary : negative transpiration, LA with NA value
```{r sorting outliers slope step2}
count_before = nrow(transp)


 data.RmOut <- transp 

    out <- boxplot(data.RmOut$TR_RATE, plot = FALSE)$out # values to remove
    tf <- which(data.RmOut$TR_RATE %in% out) # position in the list
    data.RmOut$TR_RATE[tf] <- NA
    
    
    ## negative values  
 for (i in 1:nrow(data.RmOut)) {
       data.RmOut$TR_RATE[i][data.RmOut$TR_RATE[i]<0] <- NA 
 }
 
        data.RmOut = na.omit(data.RmOut)

count_after = nrow(data.RmOut)

out_tot = count_before - count_after



paste0("still ", nrow(data.RmOut ), " observations on ",  nlevels(data.RmOut $N_GENO), " genotypes ", out_tot, " outliers removed")
```

### Variability among repetitions
```{r visu TR mid cleaning }
ggplot(data.RmOut, aes(x= data.RmOut$BLOCK, y=data.RmOut$TR_RATE)) + 
  geom_boxplot() 


ggplot(data.RmOut, aes(x= data.RmOut$REPETITION, y=data.RmOut$TR_RATE)) + 
  geom_boxplot()


ggplot(data.RmOut, aes(x= data.RmOut$ROW, y=data.RmOut$TR_RATE)) + 
  geom_boxplot()


ggplot(data.RmOut, aes(x= data.RmOut$COLUMN, y=data.RmOut$TR_RATE)) + 
  geom_boxplot()


ggplot(data.RmOut, aes(x= data.RmOut$BLOCK, y=data.RmOut$TR_G_H)) + 
  geom_boxplot() 


ggplot(data.RmOut, aes(x= data.RmOut$REPETITION, y=data.RmOut$TR_G_H)) + 
  geom_boxplot()


ggplot(data.RmOut, aes(x= data.RmOut$ROW, y=data.RmOut$TR_G_H)) + 
  geom_boxplot()


ggplot(data.RmOut, aes(x= data.RmOut$COLUMN, y=data.RmOut$TR_G_H)) + 
  geom_boxplot()




```



```{r anova TR among rep/block}
## ANOVA TRrate among repetitions block

model<-lm(TR_RATE~REPETITION, data = data.RmOut)
aov<-Anova(model)
print(aov)


model<-lm(TR_RATE~BLOCK, data = data.RmOut)
aov<-Anova(model)
print(aov)

model<-lm(TR_RATE~ROW, data = data.RmOut)
aov<-Anova(model)
print(aov)

model<-lm(TR_RATE~COLUMN, data = data.RmOut)
aov<-Anova(model)
print(aov)



model<-lm(TR_G_H~REPETITION, data = data.RmOut)
aov<-Anova(model)
print(aov)


model<-lm(TR_G_H~BLOCK, data = data.RmOut)
aov<-Anova(model)
print(aov)

model<-lm(TR_G_H~ROW, data = data.RmOut)
aov<-Anova(model)
print(aov)

model<-lm(TR_G_H~COLUMN, data = data.RmOut)
aov<-Anova(model)
print(aov)


```



```{r}
# save after cleaning
data = data.RmOut
save(data, file = paste0(opPATH.obj, "cleaned_data_TR_ETREF_",trial,".RData"))
```


### 1.1. run models for TRrate- *VPD* 

#### extract the slope for linear model
```{r model linear TRrate - VPD}
formula <-  y~(0+x)  
model_name = "linear_TRrate_VPD"

data$N_GENO = as.factor(data$N_GENO)
data$REPETITION <- as.factor(data$REPETITION)

################## REP 1 ################## 


outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
  na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep1_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)
 
 
 

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 1,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,1 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
         }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 
}

################## REP 2 ################## 
 
 
outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep2_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 2,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,2)), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    # print(i)
    }

   if (nrow(subset_geno_trt) > 2) { 
  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_RATE

   mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  

  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
}
################## REP 3 ################## 

 
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep3_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 3,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,3 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
         }

   if (nrow(subset_geno_trt) > 2) { 
  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
 BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  

  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                  AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
 
################## REP 4 ################## 

outputfile<- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep4_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 4,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,4 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
         }

   if (nrow(subset_geno_trt) > 2) { 
  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
 BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                   AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }

files_int <- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )

coef_intercept_geno <- do.call(rbind, lapply(files_int, read.table, sep = ",", fill = TRUE, header = TRUE))
coef_intercept_geno=na.omit(coef_intercept_geno)


```

#### extract the slopes and bkpt for segmented model

```{r model bkpt TRrate - VPD, message=FALSE}
####" Breakpoint model
model_name = "breakpoint_TRrate_VPD"

############ REP 1

outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep1_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 1)  
  

  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
  BIC_val  <- BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  

  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
    # print(i)
  
} else {
  message(" segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  

  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  
  
  
############ REP 2


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep2_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 2)  
  

  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
 AIC_val  <- AIC(mod)
  BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
    # print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


############ REP 3
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj","AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep3_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)





for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 3)  
  

  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
AIC_val  <- AIC(mod)
  BIC_val  <- BIC(mod)
    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
    # print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  




############ REP 4


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep4_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)

header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 4)  
  

  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
 AIC_val  <- AIC(mod)
  BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
    # print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


files_bkpt <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
coef_bkpt_geno <- do.call(rbind, lapply(files_bkpt, read.table, sep = ",", fill = TRUE, header= TRUE))
```

```{r }
# "N_GENO"     "GENO_NAME"  "REPETITION" "SLOPE_X"    "BKPT"       "SLOPE_X2"   "R2"         "R2adj"      "AIC"        "model"  
colnames(coef_bkpt_geno)[colnames(coef_bkpt_geno) == "SLOPE_X"] <- "SLOPE" ## same colnames for slope to merge them o

# Find common column names
dfs <- list(coef_bkpt_geno, coef_intercept_geno)
com_col <- Reduce(intersect, lapply(dfs, colnames))
# Subset each DF to only common columns
dfs_common <- lapply(dfs, function(df) df[com_col])
# Now safely rbind
coef_geno_rep_model_TRrate_VPD <- do.call(rbind, dfs_common)

```

#### boxplot

```{r  TRrate_VPD }
coef_geno_rep_model_TRrate_VPD$model = as.factor(coef_geno_rep_model_TRrate_VPD$model)
nlevels(coef_geno_rep_model_TRrate_VPD$model)

coef_geno_rep_model_TRrate_VPD$AIC = as.numeric(coef_geno_rep_model_TRrate_VPD$AIC)
coef_geno_rep_model_TRrate_VPD$R2 = as.numeric(coef_geno_rep_model_TRrate_VPD$R2)

#boxplot to visualize difference in R and AIC among model in general
# AIC comparison
AIC_plot <- ggplot(coef_geno_rep_model_TRrate_VPD, 
                   aes(x = model, y = AIC, fill = model)) + 
  geom_boxplot() +
  labs(title = paste("AIC by model", trait_name, trial),
       x = "Model", y = "AIC") +
  theme_minimal() +
  theme(legend.position = "none")

print(AIC_plot)

# R² comparison
R2_plot <- ggplot(coef_geno_rep_model_TRrate_VPD, 
                  aes(x = model, y = R2, fill = model)) + 
  geom_boxplot() +
  labs(title = paste("R² by model", trait_name, trial),
       x = "Model", y = "R²") +
  theme_minimal() +
  theme(legend.position = "none")

print(R2_plot)


#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_AIC_TRrate_VPD_", trait_name, "_", trial ,".png"),
  plot = AIC_plot,
  width = 6,
  height = 4
)


#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_R2_TRrate_VPD_",  trait_name, "_", trial ,".png"),
  plot = R2_plot,
  width = 6,
  height = 4
)


```

#### AIC 

```{r  best model  AIC }
coef_geno_rep_model_TRrate_VPD$GENO_TRT = NA
coef_geno_rep_model_TRrate_VPD$GENO_TRT = paste(coef_geno_rep_model_TRrate_VPD$N_GENO, coef_geno_rep_model_TRrate_VPD$REPETITION, sep = "_")
coef_geno_rep_model_TRrate_VPD$GENO_TRT = as.factor(coef_geno_rep_model_TRrate_VPD$GENO_TRT)
  save(coef_geno_rep_model_TRrate_VPD, file = paste(opPATH.obj,"coef_geno_rep_model_TRrate_VPD.RData", sep = ""))


  output <- paste(trial, trait_name, "best_model_AIC_TRrate_VPD", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



 for ( i in levels(coef_geno_rep_model_TRrate_VPD$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TRrate_VPD[coef_geno_rep_model_TRrate_VPD$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele
 index_min <- which.min(subset$AIC) 
  row_min =  subset[index_min, ]
 
   write.table(row_min, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
    # print(i)
  
 }

  


```

```{r }
best_model_AIC <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)

print(paste("best model AIC  linear to describe TRrate- VPD for (%) ", sum(best_model_AIC$model == "linear_TRrate_VPD" )/nrow(best_model_AIC)*100))
print(paste("best model AIC  breakpoint to describe TRrate- VPD for (%) ",sum(best_model_AIC$model == "breakpoint_TRrate_VPD" )/nrow(best_model_AIC)*100))

```
#### R2 

```{r best model R2}
  output <- paste(trial, trait_name, "best_model_R2_TRrate_VPD", sep = "_")
    outputfile <- paste0(opPATH.obj,output, ".txt")


  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

for ( i in levels(coef_geno_rep_model_TRrate_VPD$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TRrate_VPD[coef_geno_rep_model_TRrate_VPD$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele

 index_max <- which.max(subset$R2) ## find rownameswith max value R2
  row_max =  subset[index_max, ]
  
  
   write.table(row_max, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   # print(i)
   
}
```

```{r }
best_model_R2 <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)
print(paste("best model R2 linear to describe TRrate - VPD for (%) ",sum(best_model_R2$model == "linear_TRrate_VPD")/nrow(best_model_R2)*100))
print(paste("best model R2 breakpoint to describe TRrate - VPD for (%) ",sum(best_model_R2$model == "breakpoint_TRrate_VPD")/nrow(best_model_R2)*100))

```

#### plot model 

```{r plot models TRrate- VPD}
rep_colors <- c(
  "1" = "#A65E00",
  "2" = "#1C64A6",
  "3" = "#006747",
  "4" = "#7A2E00"
)

path <- paste0("./figures/TRrate_VPD_models/", trial, "/")
opPATH.plot_TR <- path
if (!dir.exists(opPATH.plot_TR)) dir.create(opPATH.plot_TR, recursive = TRUE)

data$N_GENO <- as.factor(data$N_GENO)

for (i in levels(data$N_GENO)) {

  subset <- data %>% filter(N_GENO == i)
  geno_name <- subset$GENO_NAME[1]

  # Keep repetitions with ≥ 3 complete values
  valid_reps <- subset %>%
    group_by(REPETITION) %>%
    filter(sum(!is.na(TR_RATE) & !is.na(MEAN_VPD)) >= 3) %>%
    pull(REPETITION) %>%
    unique()

  subset <- subset %>% filter(REPETITION %in% valid_reps)
  subset$REPETITION <- factor(subset$REPETITION)

  if (length(valid_reps) > 0) {

    # ---------------------------
    # Common x-axis limits
    # ---------------------------
    x_limits <- c(0, max(subset$MEAN_VPD, na.rm = TRUE))

    # ---------------------------
    # 1. Linear model (intercept = 0)
    # ---------------------------
    label_lin <- subset %>%
      group_by(REPETITION) %>%
      reframe({
        mod <- lm(TR_RATE ~ 0 + MEAN_VPD, data = cur_data())
        slope <- coef(mod)[["MEAN_VPD"]]
        r2_val <- summary(mod)$r.squared
        eq <- paste0("y = ", format(slope, scientific = TRUE, digits = 3), " * x")
        tibble(
          slope = slope,
          intercept = 0,
          eq = eq,
          r2 = round(r2_val, 2)
        )
      }) %>%
      arrange(REPETITION) %>%
      mutate(
        x_label = x_limits[1] + seq(0, 0.1 * diff(x_limits), length.out = n()),
        y_label = seq(max(subset$TR_RATE) * 1.05,
                      max(subset$TR_RATE) * 0.85,
                      length.out = n())
      )

    p1 <- ggplot(subset, aes(MEAN_VPD, TR_RATE, color = REPETITION)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ 0 + x, se = FALSE, linewidth = 1) +
      geom_abline(
        data = label_lin,
        aes(slope = slope, intercept = intercept, color = REPETITION),
        linetype = "dashed",
        linewidth = 0.8,
        inherit.aes = FALSE
      ) +
      geom_text(
        data = label_lin,
        aes(x = x_label, y = y_label,
            label = paste0(eq, " R² = ", r2),
            color = REPETITION),
        hjust = 0, vjust = 1, size = 4,
        inherit.aes = FALSE, show.legend = FALSE
      ) +
      scale_color_manual(values = rep_colors) +
      labs(
        title = paste0("Linear model (intercept = 0) - Genotype ", i, " - ", geno_name),
        x = "VPD (kPa)",
        y = "Tr rate (g·h⁻¹·cm⁻²)"
      ) +
      theme_bw(base_size = 14) +
      coord_cartesian(xlim = x_limits)

    # ---------------------------
    # 2. Segmented model
    # ---------------------------
    all_bp_data <- data.frame()
    annotations <- data.frame()

    for (rep in unique(subset$REPETITION)) {

      subset_rep <- subset %>% filter(REPETITION == rep)

      bp_model <- tryCatch({
        lm_base <- lm(TR_RATE ~ MEAN_VPD, data = subset_rep)
        segmented(
          lm_base,
          seg.Z = ~ MEAN_VPD,
          psi = list(MEAN_VPD = median(subset_rep$MEAN_VPD, na.rm = TRUE))
        )
      }, error = function(e) NULL)

      if (!is.null(bp_model)) {

        bp_pred <- data.frame(
          MEAN_VPD = seq(min(subset_rep$MEAN_VPD),
                         max(subset_rep$MEAN_VPD),
                         length.out = 100)
        )
        bp_pred$TR_RATE <- predict(bp_model, newdata = bp_pred)
        bp_pred$REPETITION <- rep
        all_bp_data <- rbind(all_bp_data, bp_pred)

        slopes <- slope(bp_model)$MEAN_VPD
        annotations <- rbind(
          annotations,
          data.frame(
            REPETITION = rep,
            label = paste0(
              "S1=", format(slopes[1], scientific = TRUE, digits = 3),
              ", S2=", format(slopes[2], scientific = TRUE, digits = 3),
              ", Psi=", round(bp_model$psi[2], 2),
              ", R²=", round(summary(bp_model)$r.squared, 2)
            )
          )
        )
      }
    }

    annotations <- annotations %>%
      arrange(REPETITION) %>%
      mutate(
        x = x_limits[2],
        y = seq(max(subset$TR_RATE) * 1.05,
                max(subset$TR_RATE) * 0.85,
                length.out = n())
      )

    p2 <- ggplot(subset, aes(MEAN_VPD, TR_RATE, color = REPETITION)) +
      geom_point() +
      geom_line(data = all_bp_data,
                aes(MEAN_VPD, TR_RATE, group = REPETITION),
                linewidth = 1) +
      geom_text(
        data = annotations,
        aes(x = x, y = y, label = label),
        hjust = 1, vjust = 1,
        size = 3.5, show.legend = FALSE
      ) +
      scale_color_manual(values = rep_colors) +
      labs(
        title = paste0("Segmented model - Genotype ", i, " - ", geno_name),
        x = "VPD (kPa)",
        y = "Tr rate (g·h⁻¹·cm⁻²)"
      ) +
      theme_bw(base_size = 14) +
      coord_cartesian(xlim = x_limits)

    # ---------------------------
    # Combine & save
    # ---------------------------
    full_plot <- p1 | p2

    ggsave(
      filename = paste0(opPATH.plot_TR,
                        "TRrate_MEAN_VPD_models_", trial,
                        "_GENO_", i, "_", geno_name, ".png"),
      plot = full_plot,
      width = 14, height = 10, dpi = 300
    )
  }
}




```


### 1.2. run models for TRrate- *ETREF* 

#### extract the slope for linear model

```{r model intercept TRrate_ETREF 0}

formula <-  y~(0+x)  
model_name = "linear_TRrate_ETREF"

data$N_GENO = as.factor(data$N_GENO)
data$REPETITION <- as.factor(data$REPETITION)

################## REP 1 ################## 


outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
  na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep1_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)
 
 
 

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 1,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,1 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #    #print(i)         
      }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
  BIC = BIC(mod)
  
    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # #print(i) 
  }
 }
   #  c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")

 
################## REP 2 ################## 
 
 
outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep2_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 2,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,2)), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
         }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
    BIC = BIC(mod)
      
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  

  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                                AIC, 
                 BIC,
                 RMSE,
                 model_name )),  
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # #print(i) 
  }
 }

################## REP 3 ################## 

 
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj","AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep3_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 3,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,3 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
         }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
    BIC = BIC(mod)
    
      
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  

  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                                AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # #print(i) 
  }
 }
################## REP 4 ################## 

outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj","AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

 
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep4_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 4,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,4 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # #print(i) 
    }

   if (nrow(subset_geno_trt) > 0) { 
 x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
    BIC = BIC(mod)
      
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  

  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                                AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # #print(i) 
  }
 }

files_int <- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )

coef_intercept_geno <- do.call(rbind, lapply(files_int, read.table, sep = ",", fill = TRUE, header = TRUE))
coef_intercept_geno=na.omit(coef_intercept_geno)


```

#### extract the slopes and bkpt for segmented model

```{r model bkpt TRrate_ETREF, message=FALSE}
####" Breakpoint model
model_name = "breakpoint_TRrate_ETREF"

############ REP 1

outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep1_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 1)  
  

  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
 AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  #print(i)
  
} else {
  message(" segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  

  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  
  
  
############ REP 2


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj","AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep2_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 2)  
  

  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)
   
     
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  

  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  #print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


############ REP 3
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep3_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)





for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 3)  
  

  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)
   
     
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  

  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  #print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  




############ REP 4


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep4_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)

header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 4)  
  

  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  #print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


files_bkpt <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
coef_bkpt_geno <- do.call(rbind, lapply(files_bkpt, read.table, sep = ",", fill = TRUE, header= TRUE))
coef_bkpt_geno=na.omit(coef_bkpt_geno)
```

```{r merge linear  and segmented  }
# "N_GENO"     "GENO_NAME"  "REPETITION" "SLOPE_X"    "BKPT"       "SLOPE_X2"   "R2"         "R2adj"      "AIC"        "model"  

colnames(coef_bkpt_geno)[colnames(coef_bkpt_geno) == "SLOPE_X"] <- "SLOPE" ## same colnames for slope to merge them o
# Find common column names
dfs <- list(coef_bkpt_geno, coef_intercept_geno)
com_col <- Reduce(intersect, lapply(dfs, colnames))
# Subset each DF to only common columns
dfs_common <- lapply(dfs, function(df) df[com_col])
# Now safely rbind
coef_geno_rep_model_TRrate_ETREF <- do.call(rbind, dfs_common)

```

#### boxplot

```{r  }
coef_geno_rep_model_TRrate_ETREF$model = as.factor(coef_geno_rep_model_TRrate_ETREF$model)
nlevels(coef_geno_rep_model_TRrate_ETREF$model)

coef_geno_rep_model_TRrate_ETREF$AIC = as.numeric(coef_geno_rep_model_TRrate_ETREF$AIC)
coef_geno_rep_model_TRrate_ETREF$R2 = as.numeric(coef_geno_rep_model_TRrate_ETREF$R2)

#boxplot to visualize difference in R and AIC among model in general
#AIC comparison
AIC_plot = ggplot(coef_geno_rep_model_TRrate_ETREF, aes(x = model, y = AIC, fill = model)) + 
  geom_boxplot() +
  labs(title = "AIC by model Type", x = "model", y = "AIC") +
  theme_minimal()
print(AIC_plot)

#R² comparison
R2_plot =ggplot(coef_geno_rep_model_TRrate_ETREF, aes(x = model, y = R2, fill = model)) + 
  geom_boxplot() +
  labs(title = "R² by model Type ", x = "model", y = "R²") +
  theme_minimal()

print(R2_plot)

#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_AIC_TRrate_ETREF_", trait_name, "_", trial ,".png"),
  plot = AIC_plot,
  width = 6,
  height = 4
)


#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_R2_TRrate_ETREF_",  trait_name, "_", trial ,".png"),
  plot = R2_plot,
  width = 6,
  height = 4
)


```

#### AIC 

```{r   }
coef_geno_rep_model_TRrate_ETREF$GENO_TRT = NA
coef_geno_rep_model_TRrate_ETREF$GENO_TRT = paste(coef_geno_rep_model_TRrate_ETREF$N_GENO, coef_geno_rep_model_TRrate_ETREF$REPETITION, sep = "_")
coef_geno_rep_model_TRrate_ETREF$GENO_TRT = as.factor(coef_geno_rep_model_TRrate_ETREF$GENO_TRT)
  save(coef_geno_rep_model_TRrate_ETREF, file = paste(opPATH.obj,"coef_geno_rep_model_TRrate_ETREF.RData", sep = ""))


  output <- paste(trial, trait_name, "best_model_AIC_TRrate_ETREF", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



 for ( i in levels(coef_geno_rep_model_TRrate_ETREF$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TRrate_ETREF[coef_geno_rep_model_TRrate_ETREF$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele
 index_min <- which.min(subset$AIC) 
  row_min =  subset[index_min, ]
 
   write.table(row_min, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   # #print(i)
  
 }


```

```{r }
best_model_AIC <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)
print(paste("best model AIC  linear for (%) ",sum(best_model_AIC$model == "linear_TRrate_ETREF")/nrow(best_model_AIC)*100))
print(paste("best model AIC  breakpoint for (%) ",sum(best_model_AIC$model == "breakpoint_TRrate_ETREF")/nrow(best_model_AIC)*100))


```

#### R2 

```{r }
  output <- paste(trial, trait_name, "best_model_R2_TRrate_ETREF", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

for ( i in levels(coef_geno_rep_model_TRrate_ETREF$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TRrate_ETREF[coef_geno_rep_model_TRrate_ETREF$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele

 index_max <- which.max(subset$R2) ## find rownameswith max value R2
  row_max =  subset[index_max, ]
  
  
   write.table(row_max, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   # #print(i)
   
}
  
 
```

```{r }
best_model_R2 <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)

print(paste("best model R2 linear for (%) ",sum(best_model_R2$model == "linear_TRrate_ETREF")/nrow(best_model_R2)*100))
print(paste("best model R2 breakpoint for (%) ",sum(best_model_R2$model == "breakpoint_TRrate_ETREF")/nrow(best_model_R2)*100))
```
#### plot model 


```{r plot  TRrate- ETREF}

rep_colors <- c(
  "1" = "#A65E00",
  "2" = "#1C64A6",
  "3" = "#006747",
  "4" = "#7A2E00"
)


path = paste0("./figures/TRrate_ETREF_models/", trial, "/")

opPATH.plot_TR= path
  if (!dir.exists(opPATH.plot_TR)) dir.create(opPATH.plot_TR, recursive = TRUE)

data$N_GENO = as.factor(data$N_GENO)

for (i in levels(data$N_GENO)) {

  subset <- data %>% filter(N_GENO == i)
  geno_name <- subset$GENO_NAME[1]

  # Keep only repetitions with ≥ 3 complete cases
  valid_reps <- subset %>%
    group_by(REPETITION) %>%
    filter(sum(!is.na(TR_RATE) & !is.na(ETREF)) >= 3) %>%
    pull(REPETITION) %>%
    unique()

  subset <- subset %>% filter(REPETITION %in% valid_reps)
  subset$REPETITION <- factor(subset$REPETITION)

  if ((length(valid_reps) > 0) == TRUE) {

  ### -----------------------
  ### 1. Linear model (intercept = 0)
  ### -----------------------

  
# prep labels
label_lin <- subset %>%
group_by(REPETITION) %>%
reframe({
  mod <- lm(TR_RATE ~ 0 + ETREF, data = cur_data())
  slope <- as.numeric(coef(mod)[["ETREF"]])
  r2_val <- summary(mod)$r.squared
# 
  eq <- paste0("y = ", format(slope, scientific = TRUE, digits = 3), " * x")
  
  tibble(
    REPETITION = cur_group()$REPETITION[[1]],
    slope = slope,
    intercept = 0,
    eq = eq,
    r2 = round(r2_val, 2)
  )
}) %>%
ungroup() %>%
arrange(REPETITION) %>%
mutate(
  # Position de base en haut à gauche
  x_base = 0,
  y_top = max(subset$TR_RATE) * 1.05,
  y_bottom = y_top - 0.2 * (y_top - min(subset$TR_RATE)),
  # répartir verticalement du haut vers le bas
  y_label = y_top - (row_number() - 1) * (y_top - y_bottom) / (n() - 1),
  # petit décalage horizontal pour chaque répétition
  x_label = x_base + (row_number() - 1) * 0.05 * (max(subset$ETREF) - min(subset$ETREF))
)


# ### Graphique : points, régression, droite prolongée, labels fixes en haut à gauche
p1 <- ggplot(subset, aes(x = ETREF, y = TR_RATE, color = REPETITION)) +
geom_point() +
# 
# régression locale
geom_smooth(method = "lm", formula = y ~ 0 + x, se = FALSE, linewidth = 1) +
# 
# droite prolongée en pointillé
geom_abline(
  data = label_lin,
  aes(slope = slope, intercept = intercept, color = REPETITION),
  linetype = "dashed",
  linewidth = 0.8,
  inherit.aes = FALSE
) +
# 
# labels équations + R² avec léger décalage
geom_text(
  data = label_lin,
  aes(x = x_label, y = y_label, label = paste0(eq, " R² = ", r2), color = REPETITION),
  hjust = 0,  # aligné à gauche
  vjust = 1,  # aligné vers le haut
  size = 4,
  show.legend = FALSE,
  inherit.aes = FALSE
) +
# 
scale_color_manual(values = rep_colors) +
labs(
  title = paste0("Linear model (intercept = 0) - Genotype ", i, " - ", geno_name),
  x = "ETREF (mm.h⁻¹)",
  y = "Tr rate (g·h⁻¹·cm⁻²)",
  color = "Repetition"
) +
theme_bw(base_size = 14) +
# 
# axe x commence à 0
coord_cartesian(xlim = c(0, NA))


}
# ### -----------------------
#     ### 2. Segmented (breakpoint) model
#  # ---------------------------
 all_bp_data <- data.frame()
 annotations <- data.frame(REPETITION = factor(),
                         label = character(),
                           x = numeric(),
                           y = numeric(),
                           stringsAsFactors = FALSE)
 
 # ---------------------------
# # Boucle sur chaque répétition
# # ---------------------------

  for (rep in unique(subset$REPETITION)) {
  subset_rep <- subset %>% filter(REPETITION == rep)
  subset_rep$ETREF <- as.numeric(subset_rep$ETREF)

 
  bp_model <- tryCatch({
    lm_base <- lm(TR_RATE ~ ETREF, data = subset_rep)
    segmented(lm_base, seg.Z = ~ ETREF,
              psi = list(ETREF = median(subset_rep$ETREF, na.rm = TRUE)))
  }, error = function(e) NULL)
  
  
  if (!is.null(bp_model)) {
#     # Générer les prédictions
    bp_data <- tryCatch({
      data.frame(ETREF = seq(min(subset_rep$ETREF),
                                max(subset_rep$ETREF),
                                length.out = 100)) %>%
        mutate(TR_RATE = predict(bp_model, newdata = .),
               REPETITION = rep)
    }, error = function(e) NULL)

    if (!is.null(bp_data)) all_bp_data <- rbind(all_bp_data, bp_data)

  #  Récupérer les pentes et breakpoint
    slope_vals <- tryCatch(slope(bp_model)$ETREF, error = function(e) NULL)
    if (!is.null(slope_vals) && length(slope_vals) >= 2) {
      slope1 <- format(slope_vals[1], scientific = TRUE, digits = 3)
      slope2 <- format(slope_vals[2], scientific = TRUE, digits = 3)
      psi <- format(bp_model$psi[2], scientific = FALSE, digits = 3)
      r2_bp <- round(summary(bp_model)$r.squared, 2)

     # Ajouter annotation
      annotations <- rbind(annotations, data.frame(
        REPETITION = rep,
        label = paste0("S1=", slope1, ", S2=", slope2,
                       ", Psi=", psi, ", R²=", r2_bp),
        stringsAsFactors = FALSE
      ))
    }
  }
}
     
# ---------------------------
# # Harmoniser les facteurs et espacer verticalement
# # ---------------------------
annotations$REPETITION <- factor(annotations$REPETITION, levels = levels(subset$REPETITION))


n_rep <- nrow(annotations)
if (n_rep > 0) {
 y_base <- max(subset$TR_RATE) * 1.05  
y_spacing <- 0.05 * (max(subset$TR_RATE) - min(subset$TR_RATE))  


annotations <- annotations %>%
  arrange(REPETITION) %>%
  mutate(
    x = max(subset$ETREF) * 1.05,
    y = y_base - (row_number() - 1) * y_spacing
  )
} else {
  annotations <- data.frame(
    REPETITION = subset$REPETITION[1],
    label = "Segmented models failed",
    x = max(subset$ETREF) * 1.05,
    y = max(subset$TR_RATE),
    stringsAsFactors = FALSE
  )
}
# 
# # ---------------------------
# # Création du graphique
# # ---------------------------
if (nrow(all_bp_data) > 0) {
  p2 <- ggplot(subset, aes(x = ETREF, y = TR_RATE, color = REPETITION)) +
    geom_point() +
    geom_line(data = all_bp_data,
              aes(x = ETREF, y = TR_RATE, group = REPETITION, color = REPETITION),
              size = 1) +
    geom_text(data = annotations,
              aes(x = x, y = y, label = label, color = REPETITION),
              hjust = 1, vjust = 1, size = 3.5, show.legend = FALSE) +
    scale_color_manual(values = rep_colors) +
    labs(title = paste0("Segmented model - Genotype ", i," - ", geno_name),
      x = "ETREF (mm.h⁻¹)",
    y = "Tr rate (g·h⁻¹·cm⁻²)",      color = "Repetition") +
    theme_bw(base_size = 14)
} else {
#  fallback si tous les modèles échouent
  p2 <- ggplot() +
    annotate("text", x = 0.5, y = 0.5, label = "Segmented models failed", size = 5) +
    theme_void() +
    labs(title = paste0("Segmented (breakpoint) model - Genotype ", i, " - ", geno_name))
}


#  #  Combine plots
full_plot <- (p1 | p2)
# 
# Save combined plot
ggsave(filename = paste0(opPATH.plot_TR, "TRrate_ETREF_models_", trial, "_GENO_", i, "_",geno_name, ".png"), plot = full_plot,
       width = 14, height = 10, dpi = 300)

}


```

### 1.3. run models TRrate- *ETREFxKc*  

#### extract the slope for linear model

```{r model intercept TRrate - ETREF_KC}

formula <-  y~(0+x)  
model_name = "linear_TRrate_ETREF_KC"

data$N_GENO = as.factor(data$N_GENO)
data$REPETITION <- as.factor(data$REPETITION)

################## REP 1 ################## 


outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj","AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
  na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep1_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)
 
 
 

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 1,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,1 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
    }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
   #  c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")

 
################## REP 2 ################## 
 
 
outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep2_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 2,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,2)), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
    }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
################## REP 3 ################## 


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep3_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 3,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,3 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
      }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
################## REP 4 ################## 

outputfile<- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
 header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep4_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 4,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,4 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
    }

   if (nrow(subset_geno_trt) > 0) { 
 x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_RATE

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
   AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
files_int <- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )

coef_intercept_geno <- do.call(rbind, lapply(files_int, read.table, sep = ",", fill = TRUE, header = TRUE))
coef_intercept_geno=na.omit(coef_intercept_geno)


```

#### extract the slopes and bkpt for segmented model

```{r model bkpt TRrate_ETREF_KC, message=FALSE}
####" Breakpoint model
model_name = "breakpoint_TRrate_ETREF_KC"

############ REP 1

outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep1_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 1)  
  

  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  # #print(i)
  
} else {
  message(" segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  

  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  
  
  
############ REP 2


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep2_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 2)  
  

  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  # #print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


############ REP 3
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep3_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)





for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 3)  
  

  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  # #print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  




############ REP 4


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep4_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)

header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 4)  
  

  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_RATE
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  # #print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


files_bkpt <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
coef_bkpt_geno <- do.call(rbind, lapply(files_bkpt, read.table, sep = ",", fill = TRUE, header= TRUE))
coef_bkpt_geno=na.omit(coef_bkpt_geno)
```

```{r  }
# "N_GENO"     "GENO_NAME"  "REPETITION" "SLOPE_X"    "BKPT"       "SLOPE_X2"   "R2"         "R2adj"      "AIC"        "model"  

colnames(coef_bkpt_geno)[colnames(coef_bkpt_geno) == "SLOPE_X"] <- "SLOPE" ## same colnames for slope to merge them o

# Find common column names
dfs <- list(coef_bkpt_geno, coef_intercept_geno)
com_col <- Reduce(intersect, lapply(dfs, colnames))
# Subset each DF to only common columns
dfs_common <- lapply(dfs, function(df) df[com_col])
# Now safely rbind
coef_geno_rep_model_TRrate_ETREF_KC <- do.call(rbind, dfs_common)

```

#### boxplot

```{r  }
coef_geno_rep_model_TRrate_ETREF_KC$model = as.factor(coef_geno_rep_model_TRrate_ETREF_KC$model)
nlevels(coef_geno_rep_model_TRrate_ETREF_KC$model)

coef_geno_rep_model_TRrate_ETREF_KC$AIC = as.numeric(coef_geno_rep_model_TRrate_ETREF_KC$AIC)
coef_geno_rep_model_TRrate_ETREF_KC$R2 = as.numeric(coef_geno_rep_model_TRrate_ETREF_KC$R2)

#boxplot to visualize difference in R and AIC among model in general
#AIC comparison
AIC_plot = ggplot(coef_geno_rep_model_TRrate_ETREF_KC, aes(x = model, y = AIC, fill = model)) + 
  geom_boxplot() +
  labs(title = "AIC by model Type", x = "model", y = "AIC") +
  theme_minimal()
print(AIC_plot)

#R² comparison
R2_plot =ggplot(coef_geno_rep_model_TRrate_ETREF_KC, aes(x = model, y = R2, fill = model)) + 
  geom_boxplot() +
  labs(title = "R² by model Type", x = "model", y = "R²") +
  theme_minimal()

print(R2_plot)

#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_AIC_TRrate_ETREF_KC_", trait_name, "_", trial ,".png"),
  plot = AIC_plot,
  width = 6,
  height = 4
)


#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_R2_TRrate_ETREF_KC_",  trait_name, "_", trial ,".png"),
  plot = R2_plot,
  width = 6,
  height = 4
)


```

#### AIC 

```{r   }
coef_geno_rep_model_TRrate_ETREF_KC$GENO_TRT = NA
coef_geno_rep_model_TRrate_ETREF_KC$GENO_TRT = paste(coef_geno_rep_model_TRrate_ETREF_KC$N_GENO, coef_geno_rep_model_TRrate_ETREF_KC$REPETITION, sep = "_")
coef_geno_rep_model_TRrate_ETREF_KC$GENO_TRT = as.factor(coef_geno_rep_model_TRrate_ETREF_KC$GENO_TRT)
save(coef_geno_rep_model_TRrate_ETREF_KC, file = paste0(opPATH.obj,"coef_geno_rep_model_TRrate_ETREF_KC.RData"))
  output <- paste(trial, trait_name, "best_model_AIC_TRrate_ETREF_KC", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



 for ( i in levels(coef_geno_rep_model_TRrate_ETREF_KC$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TRrate_ETREF_KC[coef_geno_rep_model_TRrate_ETREF_KC$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele
 index_min <- which.min(subset$AIC) 
  row_min =  subset[index_min, ]
 
   write.table(row_min, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   # #print(i)
  
 }


```

```{r  }
best_model_AIC <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)
unique(best_model_AIC$model)
print(paste("best model AIC TRrate_ETREF_KC linear for (%) ",sum(best_model_AIC$model == "linear_TRrate_ETREF_KC")/nrow(best_model_AIC)*100))
print(paste("best model AIC TRrate_ETREF_KC  breakpoint for (%) ",sum(best_model_AIC$model == "breakpoint_TRrate_ETREF_KC")/nrow(best_model_AIC)*100))


```


#### R2 

```{r }
  output <- paste(trial, trait_name, "best_model_R2_TRrate_ETREF_KC", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

for ( i in levels(coef_geno_rep_model_TRrate_ETREF_KC$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TRrate_ETREF_KC[coef_geno_rep_model_TRrate_ETREF_KC$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele

 index_max <- which.max(subset$R2) ## find rownameswith max value R2
  row_max =  subset[index_max, ]
  
  
   write.table(row_max, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   # #print(i)
   
}
  
 
```

```{r }
best_model_R2 <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)

print(paste("best model R2 TRrate_ETREF_KC linear for (%) ",sum(best_model_R2$model == "linear_TRrate_ETREF_KC")/nrow(best_model_R2)*100))
print(paste("best model R2 TRrate_ETREF_KC breakpoint for (%) ",sum(best_model_R2$model == "breakpoint_TRrate_ETREF_KC")/nrow(best_model_R2)*100))

```

#### plot model 

```{r plot TRrate- ETREF_KC }
rep_colors <- c(
  "1" = "#A65E00",
  "2" = "#1C64A6",
  "3" = "#006747",
  "4" = "#7A2E00"
)


path = paste0("./figures/TRrate_ETREF_KC_models/", trial, "/")

opPATH.plot_TR= path
  if (!dir.exists(opPATH.plot_TR)) dir.create(opPATH.plot_TR, recursive = TRUE)

data$N_GENO = as.factor(data$N_GENO)

for (i in levels(data$N_GENO)) {

  subset <- data %>% filter(N_GENO == i)
  geno_name <- subset$GENO_NAME[1]

  # Keep only repetitions with ≥ 3 complete cases
  valid_reps <- subset %>%
    group_by(REPETITION) %>%
    filter(sum(!is.na(TR_RATE) & !is.na(ETREF_KC)) >= 3) %>%
    pull(REPETITION) %>%
    unique()

  subset <- subset %>% filter(REPETITION %in% valid_reps)
  subset$REPETITION <- factor(subset$REPETITION)

  if ((length(valid_reps) > 0) == TRUE) {

  ### -----------------------
  ### 1. Linear model (intercept = 0)
  ### -----------------------

  
# prep labels
label_lin <- subset %>%
group_by(REPETITION) %>%
reframe({
  mod <- lm(TR_RATE ~ 0 + ETREF_KC, data = cur_data())
  slope <- as.numeric(coef(mod)[["ETREF_KC"]])
  r2_val <- summary(mod)$r.squared
# 
  eq <- paste0("y = ", format(slope, scientific = TRUE, digits = 3), " * x")
  
  tibble(
    REPETITION = cur_group()$REPETITION[[1]],
    slope = slope,
    intercept = 0,
    eq = eq,
    r2 = round(r2_val, 2)
  )
}) %>%
ungroup() %>%
arrange(REPETITION) %>%
mutate(
  # Position de base en haut à gauche
  x_base = 0,
  y_top = max(subset$TR_RATE) * 1.05,
  y_bottom = y_top - 0.2 * (y_top - min(subset$TR_RATE)),
  # répartir verticalement du haut vers le bas
  y_label = y_top - (row_number() - 1) * (y_top - y_bottom) / (n() - 1),
  # petit décalage horizontal pour chaque répétition
  x_label = x_base + (row_number() - 1) * 0.05 * (max(subset$ETREF_KC) - min(subset$ETREF_KC))
)


# ### Graphique : points, régression, droite prolongée, labels fixes en haut à gauche
p1 <- ggplot(subset, aes(x = ETREF_KC, y = TR_RATE, color = REPETITION)) +
geom_point() +
# 
# régression locale
geom_smooth(method = "lm", formula = y ~ 0 + x, se = FALSE, linewidth = 1) +
# 
# droite prolongée en pointillé
geom_abline(
  data = label_lin,
  aes(slope = slope, intercept = intercept, color = REPETITION),
  linetype = "dashed",
  linewidth = 0.8,
  inherit.aes = FALSE
) +
# 
# labels équations + R² avec léger décalage
geom_text(
  data = label_lin,
  aes(x = x_label, y = y_label, label = paste0(eq, " R² = ", r2), color = REPETITION),
  hjust = 0,  # aligné à gauche
  vjust = 1,  # aligné vers le haut
  size = 4,
  show.legend = FALSE,
  inherit.aes = FALSE
) +
# 
scale_color_manual(values = rep_colors) +
labs(
  title = paste0("Linear model (intercept = 0) - Genotype ", i, " - ", geno_name),
  x = "ETREF_KC (mm.day⁻¹.kPa)",
  y = "Tr rate (g·h⁻¹·cm⁻²)",
  color = "Repetition"
) +
theme_bw(base_size = 14) +
# 
# axe x commence à 0
coord_cartesian(xlim = c(0, NA))


}
# ### -----------------------
#     ### 2. Segmented (breakpoint) model
#  # ---------------------------
 all_bp_data <- data.frame()
 annotations <- data.frame(REPETITION = factor(),
                         label = character(),
                           x = numeric(),
                           y = numeric(),
                           stringsAsFactors = FALSE)
 
 # ---------------------------
# # Boucle sur chaque répétition
# # ---------------------------

  for (rep in unique(subset$REPETITION)) {
  subset_rep <- subset %>% filter(REPETITION == rep)
  subset_rep$ETREF_KC <- as.numeric(subset_rep$ETREF_KC)

 
  bp_model <- tryCatch({
    lm_base <- lm(TR_RATE ~ ETREF_KC, data = subset_rep)
    segmented(lm_base, seg.Z = ~ ETREF_KC,
              psi = list(ETREF_KC = median(subset_rep$ETREF_KC, na.rm = TRUE)))
  }, error = function(e) NULL)
  
  
  if (!is.null(bp_model)) {
#     # Générer les prédictions
    bp_data <- tryCatch({
      data.frame(ETREF_KC = seq(min(subset_rep$ETREF_KC),
                                max(subset_rep$ETREF_KC),
                                length.out = 100)) %>%
        mutate(TR_RATE = predict(bp_model, newdata = .),
               REPETITION = rep)
    }, error = function(e) NULL)

    if (!is.null(bp_data)) all_bp_data <- rbind(all_bp_data, bp_data)

  #  Récupérer les pentes et breakpoint
    slope_vals <- tryCatch(slope(bp_model)$ETREF_KC, error = function(e) NULL)
    if (!is.null(slope_vals) && length(slope_vals) >= 2) {
      slope1 <- format(slope_vals[1], scientific = TRUE, digits = 3)
      slope2 <- format(slope_vals[2], scientific = TRUE, digits = 3)
      psi <- format(bp_model$psi[2], scientific = FALSE, digits = 3)
      r2_bp <- round(summary(bp_model)$r.squared, 2)

     # Ajouter annotation
      annotations <- rbind(annotations, data.frame(
        REPETITION = rep,
        label = paste0("S1=", slope1, ", S2=", slope2,
                       ", Psi=", psi, ", R²=", r2_bp),
        stringsAsFactors = FALSE
      ))
    }
  }
}
     
# ---------------------------
# # Harmoniser les facteurs et espacer verticalement
# # ---------------------------
annotations$REPETITION <- factor(annotations$REPETITION, levels = levels(subset$REPETITION))


n_rep <- nrow(annotations)
if (n_rep > 0) {
 y_base <- max(subset$TR_RATE) * 1.05  
y_spacing <- 0.05 * (max(subset$TR_RATE) - min(subset$TR_RATE))  


annotations <- annotations %>%
  arrange(REPETITION) %>%
  mutate(
    x = max(subset$ETREF_KC) * 1.05,
    y = y_base - (row_number() - 1) * y_spacing
  )
} else {
  annotations <- data.frame(
    REPETITION = subset$REPETITION[1],
    label = "Segmented models failed",
    x = max(subset$ETREF_KC) * 1.05,
    y = max(subset$TR_RATE),
    stringsAsFactors = FALSE
  )
}
# 
# # ---------------------------
# # Création du graphique
# # ---------------------------
if (nrow(all_bp_data) > 0) {
  p2 <- ggplot(subset, aes(x = ETREF_KC, y = TR_RATE, color = REPETITION)) +
    geom_point() +
    geom_line(data = all_bp_data,
              aes(x = ETREF_KC, y = TR_RATE, group = REPETITION, color = REPETITION),
              size = 1) +
    geom_text(data = annotations,
              aes(x = x, y = y, label = label, color = REPETITION),
              hjust = 1, vjust = 1, size = 3.5, show.legend = FALSE) +
    scale_color_manual(values = rep_colors) +
    labs(title = paste0("Segmented model - Genotype ", i," - ", geno_name),
      x = "ETREF_KC (mm.day⁻¹.kPa)",
    y = "Tr rate (g·h⁻¹·cm⁻²)",      color = "Repetition") +
    theme_bw(base_size = 14)
} else {
#  fallback si tous les modèles échouent
  p2 <- ggplot() +
    annotate("text", x = 0.5, y = 0.5, label = "Segmented models failed", size = 5) +
    theme_void() +
    labs(title = paste0("Segmented (breakpoint) model - Genotype ", i, " - ", geno_name))
}


#  #  Combine plots
full_plot <- (p1 | p2)
# 
# Save combined plot
ggsave(filename = paste0(opPATH.plot_TR, "TRrate_ETREF_KC_models_", trial, "_GENO_", i, "_",geno_name, ".png"), plot = full_plot,
       width = 14, height = 10, dpi = 300)

}

```


### 2.1 run models TR- *VPD* 

#### extract the slope for linear model

```{r model intercept 0 TR - VPD}

formula <-  y~(0+x)  
model_name = "linear_TR_VPD"

data$N_GENO = as.factor(data$N_GENO)
data$REPETITION <- as.factor(data$REPETITION)

################## REP 1 ################## 


outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
  na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep1_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)
 
 
 

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 1,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,1 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
    }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
 AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
   #  c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")

 
################## REP 2 ################## 
 
 
outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep2_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 2,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,2)), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
    }

   if (nrow(subset_geno_trt) > 2) { 
  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
 AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }

################## REP 3 ################## 

 
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep3_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 3,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,3 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
    }

   if (nrow(subset_geno_trt) > 2) { 
  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
 AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
################## REP 4 ################## 

outputfile<- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
 header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep4_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 4,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,4 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
    }

   if (nrow(subset_geno_trt) > 2) { 
  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
 AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
 

files_int <- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )

coef_intercept_geno <- do.call(rbind, lapply(files_int, read.table, sep = ",", fill = TRUE, header = TRUE))
coef_intercept_geno=na.omit(coef_intercept_geno)


```

#### extract the slopes and bkpt for segmented model

```{r model bkpt TR - VPD, message=FALSE}
####" Breakpoint model
model_name = "breakpoint_TR_VPD"

############ REP 1

outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep1_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 1)  
  

  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  # #print(i) 
  
} else {
  message(" segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  

  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  
  
  
############ REP 2


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep2_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 2)  
  

  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  # #print(i) 
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


############ REP 3
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep3_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)





for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 3)  
  

  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  # #print(i) 
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  




############ REP 4


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep4_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)

header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 4)  
  

  x <- subset_geno_trt$MEAN_VPD
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  # #print(i) 
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


files_bkpt <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
coef_bkpt_geno <- do.call(rbind, lapply(files_bkpt, read.table, sep = ",", fill = TRUE, header= TRUE))
coef_bkpt_geno=na.omit(coef_bkpt_geno)
```

```{r }
# "N_GENO"     "GENO_NAME"  "REPETITION" "SLOPE_X"    "BKPT"       "SLOPE_X2"   "R2"         "R2adj"      "AIC"        "model"  
colnames(coef_bkpt_geno)[colnames(coef_bkpt_geno) == "SLOPE_X"] <- "SLOPE" ## same colnames for slope to merge them o

# Find common column names
dfs <- list(coef_bkpt_geno, coef_intercept_geno)
com_col <- Reduce(intersect, lapply(dfs, colnames))
# Subset each DF to only common columns
dfs_common <- lapply(dfs, function(df) df[com_col])
# Now safely rbind
coef_geno_rep_model_TR_VPD <- do.call(rbind, dfs_common)

```

#### boxplot

```{r  TR_VPD }
coef_geno_rep_model_TR_VPD$model = as.factor(coef_geno_rep_model_TR_VPD$model)
nlevels(coef_geno_rep_model_TR_VPD$model)

coef_geno_rep_model_TR_VPD$AIC = as.numeric(coef_geno_rep_model_TR_VPD$AIC)
coef_geno_rep_model_TR_VPD$R2 = as.numeric(coef_geno_rep_model_TR_VPD$R2)

#boxplot to visualize difference in R and AIC among model in general
#AIC comparison
AIC_plot = ggplot(coef_geno_rep_model_TR_VPD, aes(x = model, y = AIC, fill = model)) + 
  geom_boxplot() +
  labs(title = "AIC by model Type", x = "model", y = "AIC") +
  theme_minimal()
print(AIC_plot)

#R² comparison
R2_plot =ggplot(coef_geno_rep_model_TR_VPD, aes(x = model, y = R2, fill = model)) + 
  geom_boxplot() +
  labs(title = "R² by model Type", x = "model", y = "R²") +
  theme_minimal()

print(R2_plot)

#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_AIC_TR_VPD_", trait_name, "_", trial ,".png"),
  plot = AIC_plot,
  width = 6,
  height = 4
)


#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_R2_TR_VPD_",  trait_name, "_", trial ,".png"),
  plot = R2_plot,
  width = 6,
  height = 4
)


```

#### AIC 

```{r   }
coef_geno_rep_model_TR_VPD$GENO_TRT = NA
coef_geno_rep_model_TR_VPD$GENO_TRT = paste(coef_geno_rep_model_TR_VPD$N_GENO, coef_geno_rep_model_TR_VPD$REPETITION, sep = "_")
coef_geno_rep_model_TR_VPD$GENO_TRT = as.factor(coef_geno_rep_model_TR_VPD$GENO_TRT)

save(coef_geno_rep_model_TR_VPD, file = paste0(opPATH.obj,"coef_geno_rep_model_TR_VPD.RData"))

  output <- paste(trial, trait_name, "best_model_AIC_TR_VPD", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



 for ( i in levels(coef_geno_rep_model_TR_VPD$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TR_VPD[coef_geno_rep_model_TR_VPD$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele
 index_min <- which.min(subset$AIC) 
  row_min =  subset[index_min, ]
 
   write.table(row_min, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   #print(i)
  
 }


```

```{r  }
best_model_AIC <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)

print(paste("best model AIC  linear to describe TR- VPD for (%) ",sum(best_model_AIC$model == "linear_TR_VPD")/nrow(best_model_AIC)*100))
print(paste("best model AIC  breakpoint to describe TR- VPD for (%) ",sum(best_model_AIC$model == "breakpoint_TR_VPD" )/nrow(best_model_AIC)*100))
```

#### R2 

```{r }
  output <- paste(trial, trait_name, "best_model_R2_TR_VPD", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

for ( i in levels(coef_geno_rep_model_TR_VPD$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TR_VPD[coef_geno_rep_model_TR_VPD$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele

 index_max <- which.max(subset$R2) ## find rownameswith max value R2
  row_max =  subset[index_max, ]
  
  
   write.table(row_max, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   # #print(i)
   
}
  
 
```

```{r }
best_model_R2 <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)

print(paste("best model R2 linear to describe TR - VPD for (%) ",sum(best_model_R2$model == "linear_TR_VPD")/nrow(best_model_R2)*100))
print(paste("best model R2 breakpoint to describe TR - VPD for (%) ",sum(best_model_R2$model == "breakpoint_TR_VPD")/nrow(best_model_R2)*100))

```

#### plot model 

```{r plot TR- VPD}

rep_colors <- c(
  "1" = "#A65E00",
  "2" = "#1C64A6",
  "3" = "#006747",
  "4" = "#7A2E00"
)


path = paste0("./figures/TR_VPD_models/", trial, "/")

opPATH.plot_TR= path
  if (!dir.exists(opPATH.plot_TR)) dir.create(opPATH.plot_TR, recursive = TRUE)

data$N_GENO = as.factor(data$N_GENO)

for (i in levels(data$N_GENO)) {

  subset <- data %>% filter(N_GENO == i)
  geno_name <- subset$GENO_NAME[1]

  # Keep only repetitions with ≥ 3 complete cases
  valid_reps <- subset %>%
    group_by(REPETITION) %>%
    filter(sum(!is.na(TR_G_H) & !is.na(MEAN_VPD)) >= 3) %>%
    pull(REPETITION) %>%
    unique()

  subset <- subset %>% filter(REPETITION %in% valid_reps)
  subset$REPETITION <- factor(subset$REPETITION)

  if ((length(valid_reps) > 0) == TRUE) {

  ### -----------------------
  ### 1. Linear model (intercept = 0)
  ### -----------------------

  
# prep labels
label_lin <- subset %>%
group_by(REPETITION) %>%
reframe({
  mod <- lm(TR_G_H ~ 0 + MEAN_VPD, data = cur_data())
  slope <- as.numeric(coef(mod)[["MEAN_VPD"]])
  r2_val <- summary(mod)$r.squared
# 
  eq <- paste0("y = ", format(slope, scientific = TRUE, digits = 3), " * x")
  
  tibble(
    REPETITION = cur_group()$REPETITION[[1]],
    slope = slope,
    intercept = 0,
    eq = eq,
    r2 = round(r2_val, 2)
  )
}) %>%
ungroup() %>%
arrange(REPETITION) %>%
mutate(
  # Position de base en haut à gauche
  x_base = 0,
  y_top = max(subset$TR_G_H) * 1.05,
  y_bottom = y_top - 0.2 * (y_top - min(subset$TR_G_H)),
  # répartir verticalement du haut vers le bas
  y_label = y_top - (row_number() - 1) * (y_top - y_bottom) / (n() - 1),
  # petit décalage horizontal pour chaque répétition
  x_label = x_base + (row_number() - 1) * 0.05 * (max(subset$MEAN_VPD) - min(subset$MEAN_VPD))
)


# ### Graphique : points, régression, droite prolongée, labels fixes en haut à gauche
p1 <- ggplot(subset, aes(x = MEAN_VPD, y = TR_G_H, color = REPETITION)) +
geom_point() +
# 
# régression locale
geom_smooth(method = "lm", formula = y ~ 0 + x, se = FALSE, linewidth = 1) +
# 
# droite prolongée en pointillé
geom_abline(
  data = label_lin,
  aes(slope = slope, intercept = intercept, color = REPETITION),
  linetype = "dashed",
  linewidth = 0.8,
  inherit.aes = FALSE
) +
# 
# labels équations + R² avec léger décalage
geom_text(
  data = label_lin,
  aes(x = x_label, y = y_label, label = paste0(eq, " R² = ", r2), color = REPETITION),
  hjust = 0,  # aligné à gauche
  vjust = 1,  # aligné vers le haut
  size = 4,
  show.legend = FALSE,
  inherit.aes = FALSE
) +
# 
scale_color_manual(values = rep_colors) +
labs(
  title = paste0("Linear model (intercept = 0) - Genotype ", i, " - ", geno_name),
  x = "VPD (kPa)",
  y = "Tr (g·h⁻¹)",
  color = "Repetition"
) +
theme_bw(base_size = 14) +
# 
# axe x commence à 0
coord_cartesian(xlim = c(0, NA))


}
# ### -----------------------
#     ### 2. Segmented (breakpoint) model
#  # ---------------------------
 all_bp_data <- data.frame()
 annotations <- data.frame(REPETITION = factor(),
                         label = character(),
                           x = numeric(),
                           y = numeric(),
                           stringsAsFactors = FALSE)
 
 # ---------------------------
# # Boucle sur chaque répétition
# # ---------------------------

  for (rep in unique(subset$REPETITION)) {
  subset_rep <- subset %>% filter(REPETITION == rep)
  subset_rep$MEAN_VPD <- as.numeric(subset_rep$MEAN_VPD)

 
  bp_model <- tryCatch({
    lm_base <- lm(TR_G_H ~ MEAN_VPD, data = subset_rep)
    segmented(lm_base, seg.Z = ~ MEAN_VPD,
              psi = list(MEAN_VPD = median(subset_rep$MEAN_VPD, na.rm = TRUE)))
  }, error = function(e) NULL)
  
  
  if (!is.null(bp_model)) {
#     # Générer les prédictions
    bp_data <- tryCatch({
      data.frame(MEAN_VPD = seq(min(subset_rep$MEAN_VPD),
                                max(subset_rep$MEAN_VPD),
                                length.out = 100)) %>%
        mutate(TR_G_H = predict(bp_model, newdata = .),
               REPETITION = rep)
    }, error = function(e) NULL)

    if (!is.null(bp_data)) all_bp_data <- rbind(all_bp_data, bp_data)

  #  Récupérer les pentes et breakpoint
    slope_vals <- tryCatch(slope(bp_model)$MEAN_VPD, error = function(e) NULL)
    if (!is.null(slope_vals) && length(slope_vals) >= 2) {
      slope1 <- format(slope_vals[1], scientific = TRUE, digits = 3)
      slope2 <- format(slope_vals[2], scientific = TRUE, digits = 3)
      psi <- format(bp_model$psi[2], scientific = FALSE, digits = 3)
      r2_bp <- round(summary(bp_model)$r.squared, 2)

     # Ajouter annotation
      annotations <- rbind(annotations, data.frame(
        REPETITION = rep,
        label = paste0("S1=", slope1, ", S2=", slope2,
                       ", Psi=", psi, ", R²=", r2_bp),
        stringsAsFactors = FALSE
      ))
    }
  }
}
     
# ---------------------------
# # Harmoniser les facteurs et espacer verticalement
# # ---------------------------
annotations$REPETITION <- factor(annotations$REPETITION, levels = levels(subset$REPETITION))


n_rep <- nrow(annotations)
if (n_rep > 0) {
 y_base <- max(subset$TR_G_H) * 1.05  
y_spacing <- 0.05 * (max(subset$TR_G_H) - min(subset$TR_G_H))  


annotations <- annotations %>%
  arrange(REPETITION) %>%
  mutate(
    x = max(subset$MEAN_VPD) * 1.05,
    y = y_base - (row_number() - 1) * y_spacing
  )
} else {
  annotations <- data.frame(
    REPETITION = subset$REPETITION[1],
    label = "Segmented models failed",
    x = max(subset$MEAN_VPD) * 1.05,
    y = max(subset$TR_G_H),
    stringsAsFactors = FALSE
  )
}
# 
# # ---------------------------
# # Création du graphique
# # ---------------------------
if (nrow(all_bp_data) > 0) {
  p2 <- ggplot(subset, aes(x = MEAN_VPD, y = TR_G_H, color = REPETITION)) +
    geom_point() +
    geom_line(data = all_bp_data,
              aes(x = MEAN_VPD, y = TR_G_H, group = REPETITION, color = REPETITION),
              size = 1) +
    geom_text(data = annotations,
              aes(x = x, y = y, label = label, color = REPETITION),
              hjust = 1, vjust = 1, size = 3.5, show.legend = FALSE) +
    scale_color_manual(values = rep_colors) +
    labs(title = paste0("Segmented model - Genotype ", i," - ", geno_name),
      x = "VPD (kPa)",
  y = "Tr (g·h⁻¹)",
    color = "Repetition") +
    theme_bw(base_size = 14)
} else {
#  fallback si tous les modèles échouent
  p2 <- ggplot() +
    annotate("text", x = 0.5, y = 0.5, label = "Segmented models failed", size = 5) +
    theme_void() +
    labs(title = paste0("Segmented (breakpoint) model - Genotype ", i, " - ", geno_name))
}


#  #  Combine plots
full_plot <- (p1 | p2)
# 
# Save combined plot
ggsave(filename = paste0(opPATH.plot_TR, "TR_MEAN_VPD_models_", trial, "_GENO_", i, "_",geno_name, ".png"), plot = full_plot,
       width = 14, height = 10, dpi = 300)

}



```


### 2.2 run models TR- *ETREf* 

#### extract the slope for linear model

```{r model intercept TR - ETREF 0}

formula <-  y~(0+x)  
model_name = "linear_TR_ETREF"

data$N_GENO = as.factor(data$N_GENO)
data$REPETITION <- as.factor(data$REPETITION)

################## REP 1 ################## 


outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
  na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep1_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)
 
 
 

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 1,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,1 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
    }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
 AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
   #  c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")

 
################## REP 2 ################## 
 
 
outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep2_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 2,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,2)), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    print(i)
    }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
   AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
################## REP 3 ################## 

 
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep3_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 3,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,3 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
   # print(i)
    }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
   AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
################## REP 4 ################## 

outputfile<- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
 header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep4_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 4,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,4 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
      }

   if (nrow(subset_geno_trt) > 0) { 
 x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
   AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
files_int <- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )

coef_intercept_geno <- do.call(rbind, lapply(files_int, read.table, sep = ",", fill = TRUE, header = TRUE))
coef_intercept_geno=na.omit(coef_intercept_geno)


```

#### extract the slopes and bkpt for segmented model

```{r model bkpt TR_ETREF, message=FALSE}
####" Breakpoint model
model_name = "breakpoint_TR_ETREF"

############ REP 1

outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep1_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 1)  
  

  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  print(i)
  
} else {
  message(" segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  

  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  
  
  
############ REP 2


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep2_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 2)  
  

  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


############ REP 3
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep3_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)





for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 3)  
  

  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  




############ REP 4


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep4_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)

header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 4)  
  

  x <- subset_geno_trt$ETREF
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


files_bkpt <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
coef_bkpt_geno <- do.call(rbind, lapply(files_bkpt, read.table, sep = ",", fill = TRUE, header= TRUE))
coef_bkpt_geno=na.omit(coef_bkpt_geno)
```

```{r   }
# "N_GENO"     "GENO_NAME"  "REPETITION" "SLOPE_X"    "BKPT"       "SLOPE_X2"   "R2"         "R2adj"      "AIC"        "model"  

colnames(coef_bkpt_geno)[colnames(coef_bkpt_geno) == "SLOPE_X"] <- "SLOPE" ## same colnames for slope to merge them o

# Find common column names
dfs <- list(coef_bkpt_geno, coef_intercept_geno)
com_col <- Reduce(intersect, lapply(dfs, colnames))
# Subset each DF to only common columns
dfs_common <- lapply(dfs, function(df) df[com_col])
# Now safely rbind
coef_geno_rep_model_TR_ETREF <- do.call(rbind, dfs_common)

```

#### boxplot

```{r  }
coef_geno_rep_model_TR_ETREF$model = as.factor(coef_geno_rep_model_TR_ETREF$model)
nlevels(coef_geno_rep_model_TR_ETREF$model)

coef_geno_rep_model_TR_ETREF$AIC = as.numeric(coef_geno_rep_model_TR_ETREF$AIC)
coef_geno_rep_model_TR_ETREF$R2 = as.numeric(coef_geno_rep_model_TR_ETREF$R2)

#boxplot to visualize difference in R and AIC among model in general
#AIC comparison
AIC_plot = ggplot(coef_geno_rep_model_TR_ETREF, aes(x = model, y = AIC, fill = model)) + 
  geom_boxplot() +
  labs(title = "AIC by model Type", x = "model", y = "AIC") +
  theme_minimal()
print(AIC_plot)

#R² comparison
R2_plot =ggplot(coef_geno_rep_model_TR_ETREF, aes(x = model, y = R2, fill = model)) + 
  geom_boxplot() +
  labs(title = "R² by model Type", x = "model", y = "R²") +
  theme_minimal()

print(R2_plot)

#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_AIC_TR_ETREF_", trait_name, "_", trial ,".png"),
  plot = AIC_plot,
  width = 6,
  height = 4
)


#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_R2_TR_ETREF_",  trait_name, "_", trial ,".png"),
  plot = R2_plot,
  width = 6,
  height = 4
)


```

#### AIC 

```{r   }
coef_geno_rep_model_TR_ETREF$GENO_TRT = NA
coef_geno_rep_model_TR_ETREF$GENO_TRT = paste(coef_geno_rep_model_TR_ETREF$N_GENO, coef_geno_rep_model_TR_ETREF$REPETITION, sep = "_")
coef_geno_rep_model_TR_ETREF$GENO_TRT = as.factor(coef_geno_rep_model_TR_ETREF$GENO_TRT)

save(coef_geno_rep_model_TR_ETREF, file = paste0(opPATH.obj, "coef_geno_rep_model_TR_ETREF.RData"))
  output <- paste(trial, trait_name, "best_model_AIC_TR_ETREF", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



 for ( i in levels(coef_geno_rep_model_TR_ETREF$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TR_ETREF[coef_geno_rep_model_TR_ETREF$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele
 index_min <- which.min(subset$AIC) 
  row_min =  subset[index_min, ]
 
   write.table(row_min, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   print(i)
  
 }


```

```{ }
best_model_AIC <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)
print(paste("best model AIC TR_ETREF linear for (%) ",sum(best_model_AIC$model == "linear_TR_ETREF")/nrow(best_model_AIC)*100))
print(paste("best model AIC TR_ETREF breakpoint for (%) ",sum(best_model_AIC$model == "breakpoint_TR_ETREF")/nrow(best_model_AIC)*100))


```

#### R2 

```{r }
  output <- paste(trial, trait_name, "best_model_R2_TR_ETREF", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

for ( i in levels(coef_geno_rep_model_TR_ETREF$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TR_ETREF[coef_geno_rep_model_TR_ETREF$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele

 index_max <- which.max(subset$R2) ## find rownameswith max value R2
  row_max =  subset[index_max, ]
  
  
   write.table(row_max, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   # print(i)
   
}
  
 
```

```{r }
best_model_R2 <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)

print(paste("best model R2 TR_ETREF linear for (%) ",sum(best_model_R2$model == "linear_TR_ETREF")/nrow(best_model_R2)*100))
print(paste("best model R2 TR_ETREF breakpoint for (%) ",sum(best_model_R2$model == "breakpoint_TR_ETREF")/nrow(best_model_R2)*100))

```

#### plot model 

```{r plot  TR- ETREF }


rep_colors <- c(
  "1" = "#A65E00",
  "2" = "#1C64A6",
  "3" = "#006747",
  "4" = "#7A2E00"
)


path = paste0("./figures/TR_ETREF_models/", trial, "/")

opPATH.plot_TR= path
  if (!dir.exists(opPATH.plot_TR)) dir.create(opPATH.plot_TR, recursive = TRUE)

data$N_GENO = as.factor(data$N_GENO)

for (i in levels(data$N_GENO)) {

  subset <- data %>% filter(N_GENO == i)
  geno_name <- subset$GENO_NAME[1]

  # Keep only repetitions with ≥ 3 complete cases
  valid_reps <- subset %>%
    group_by(REPETITION) %>%
    filter(sum(!is.na(TR_G_H) & !is.na(ETREF)) >= 3) %>%
    pull(REPETITION) %>%
    unique()

  subset <- subset %>% filter(REPETITION %in% valid_reps)
  subset$REPETITION <- factor(subset$REPETITION)

  if ((length(valid_reps) > 0) == TRUE) {

  ### -----------------------
  ### 1. Linear model (intercept = 0)
  ### -----------------------

  
# prep labels
label_lin <- subset %>%
group_by(REPETITION) %>%
reframe({
  mod <- lm(TR_G_H ~ 0 + ETREF, data = cur_data())
  slope <- as.numeric(coef(mod)[["ETREF"]])
  r2_val <- summary(mod)$r.squared
# 
  eq <- paste0("y = ", format(slope, scientific = TRUE, digits = 3), " * x")
  
  tibble(
    REPETITION = cur_group()$REPETITION[[1]],
    slope = slope,
    intercept = 0,
    eq = eq,
    r2 = round(r2_val, 2)
  )
}) %>%
ungroup() %>%
arrange(REPETITION) %>%
mutate(
  # Position de base en haut à gauche
  x_base = 0,
  y_top = max(subset$TR_G_H) * 1.05,
  y_bottom = y_top - 0.2 * (y_top - min(subset$TR_G_H)),
  # répartir verticalement du haut vers le bas
  y_label = y_top - (row_number() - 1) * (y_top - y_bottom) / (n() - 1),
  # petit décalage horizontal pour chaque répétition
  x_label = x_base + (row_number() - 1) * 0.05 * (max(subset$ETREF) - min(subset$ETREF))
)


# ### Graphique : points, régression, droite prolongée, labels fixes en haut à gauche
p1 <- ggplot(subset, aes(x = ETREF, y = TR_G_H, color = REPETITION)) +
geom_point() +
# 
# régression locale
geom_smooth(method = "lm", formula = y ~ 0 + x, se = FALSE, linewidth = 1) +
# 
# droite prolongée en pointillé
geom_abline(
  data = label_lin,
  aes(slope = slope, intercept = intercept, color = REPETITION),
  linetype = "dashed",
  linewidth = 0.8,
  inherit.aes = FALSE
) +
# 
# labels équations + R² avec léger décalage
geom_text(
  data = label_lin,
  aes(x = x_label, y = y_label, label = paste0(eq, " R² = ", r2), color = REPETITION),
  hjust = 0,  # aligné à gauche
  vjust = 1,  # aligné vers le haut
  size = 4,
  show.legend = FALSE,
  inherit.aes = FALSE
) +
# 
scale_color_manual(values = rep_colors) +
labs(
  title = paste0("Linear model (intercept = 0) - Genotype ", i, " - ", geno_name),
  x = "ETREF (mm.h⁻¹)",
  y = "Tr (g·h⁻¹)",
  color = "Repetition"
) +
theme_bw(base_size = 14) +
# 
# axe x commence à 0
coord_cartesian(xlim = c(0, NA))


}
# ### -----------------------
#     ### 2. Segmented (breakpoint) model
#  # ---------------------------
 all_bp_data <- data.frame()
 annotations <- data.frame(REPETITION = factor(),
                         label = character(),
                           x = numeric(),
                           y = numeric(),
                           stringsAsFactors = FALSE)
 
 # ---------------------------
# # Boucle sur chaque répétition
# # ---------------------------

  for (rep in unique(subset$REPETITION)) {
  subset_rep <- subset %>% filter(REPETITION == rep)
  subset_rep$ETREF <- as.numeric(subset_rep$ETREF)

 
  bp_model <- tryCatch({
    lm_base <- lm(TR_G_H ~ ETREF, data = subset_rep)
    segmented(lm_base, seg.Z = ~ ETREF,
              psi = list(ETREF = median(subset_rep$ETREF, na.rm = TRUE)))
  }, error = function(e) NULL)
  
  
  if (!is.null(bp_model)) {
#     # Générer les prédictions
    bp_data <- tryCatch({
      data.frame(ETREF = seq(min(subset_rep$ETREF),
                                max(subset_rep$ETREF),
                                length.out = 100)) %>%
        mutate(TR_G_H = predict(bp_model, newdata = .),
               REPETITION = rep)
    }, error = function(e) NULL)

    if (!is.null(bp_data)) all_bp_data <- rbind(all_bp_data, bp_data)

  #  Récupérer les pentes et breakpoint
    slope_vals <- tryCatch(slope(bp_model)$ETREF, error = function(e) NULL)
    if (!is.null(slope_vals) && length(slope_vals) >= 2) {
      slope1 <- format(slope_vals[1], scientific = TRUE, digits = 3)
      slope2 <- format(slope_vals[2], scientific = TRUE, digits = 3)
      psi <- format(bp_model$psi[2], scientific = FALSE, digits = 3)
      r2_bp <- round(summary(bp_model)$r.squared, 2)

     # Ajouter annotation
      annotations <- rbind(annotations, data.frame(
        REPETITION = rep,
        label = paste0("S1=", slope1, ", S2=", slope2,
                       ", Psi=", psi, ", R²=", r2_bp),
        stringsAsFactors = FALSE
      ))
    }
  }
}
     
# ---------------------------
# # Harmoniser les facteurs et espacer verticalement
# # ---------------------------
annotations$REPETITION <- factor(annotations$REPETITION, levels = levels(subset$REPETITION))


n_rep <- nrow(annotations)
if (n_rep > 0) {
 y_base <- max(subset$TR_G_H) * 1.05  
y_spacing <- 0.05 * (max(subset$TR_G_H) - min(subset$TR_G_H))  


annotations <- annotations %>%
  arrange(REPETITION) %>%
  mutate(
    x = max(subset$ETREF) * 1.05,
    y = y_base - (row_number() - 1) * y_spacing
  )
} else {
  annotations <- data.frame(
    REPETITION = subset$REPETITION[1],
    label = "Segmented models failed",
    x = max(subset$ETREF) * 1.05,
    y = max(subset$TR_G_H),
    stringsAsFactors = FALSE
  )
}
# 
# # ---------------------------
# # Création du graphique
# # ---------------------------
if (nrow(all_bp_data) > 0) {
  p2 <- ggplot(subset, aes(x = ETREF, y = TR_G_H, color = REPETITION)) +
    geom_point() +
    geom_line(data = all_bp_data,
              aes(x = ETREF, y = TR_G_H, group = REPETITION, color = REPETITION),
              size = 1) +
    geom_text(data = annotations,
              aes(x = x, y = y, label = label, color = REPETITION),
              hjust = 1, vjust = 1, size = 3.5, show.legend = FALSE) +
    scale_color_manual(values = rep_colors) +
    labs(title = paste0("Segmented model - Genotype ", i," - ", geno_name),
      x = "ETREF (mm.h⁻¹)",
  y = "Tr (g·h⁻¹)",
    color = "Repetition") +
    theme_bw(base_size = 14)
} else {
#  fallback si tous les modèles échouent
  p2 <- ggplot() +
    annotate("text", x = 0.5, y = 0.5, label = "Segmented models failed", size = 5) +
    theme_void() +
    labs(title = paste0("Segmented (breakpoint) model - Genotype ", i, " - ", geno_name))
}


#  #  Combine plots
full_plot <- (p1 | p2)
# 
# Save combined plot
ggsave(filename = paste0(opPATH.plot_TR, "TR_ETREF_models_", trial, "_GENO_", i, "_",geno_name, ".png"), plot = full_plot,
       width = 14, height = 10, dpi = 300)

}



```

### 2.3 run models TR- *ETREFxKc*  

#### extract the slope for linear model

```{r model intercept TR - ETREF_KC 0}

formula <-  y~(0+x)  
model_name = "linear_TR_ETREF_KC"

data$N_GENO = as.factor(data$N_GENO)
data$REPETITION <- as.factor(data$REPETITION)

################## REP 1 ################## 


outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
  na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep1_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)
 
 
 

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 1,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,1 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
         }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
   AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
   #  c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")

 
################## REP 2 ################## 
 
 
outputfile<-paste0( opPATH.obj, trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep2_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 2,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,2)), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
         }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
   AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
################## REP 3 ################## 

 
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep3_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 3,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,3 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
         }

   if (nrow(subset_geno_trt) > 0) { 
  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
################## REP 4 ################## 

outputfile<- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
 header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
 write.table(t(header), file=outputfile, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)

 
 
 na_log_file <-paste0( opPATH.obj, "NA_list_", model_name, "_rep4_", trial, ".txt")
    if (file.exists(na_log_file)) file.remove(na_log_file)
 
 header_NAfile = c("N_GENO", "REPETITION")
 write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
               col.names=FALSE, row.names=FALSE, append=TRUE)


## loop to save slope values "Estimate" , AIC R2 and R2 adj 
 for ( i in levels(data$N_GENO) ) {
   subset_geno<- data[data$N_GENO %in% c(i), ]
   subset_geno_trt<- subset_geno[subset_geno$REPETITION == 4,] 
    if (nrow(subset_geno_trt) == 0) {  
    write.table(t(c(i,4 )), file=na_log_file, sep=",",
                quote=FALSE, col.names=F, row.names=F, append=TRUE)
    #print(i)
         }

   if (nrow(subset_geno_trt) > 0) { 
 x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_G_H

  mod<-lm(formula = formula, data = subset_geno_trt)
  df_summary<-summary(mod)
  AIC<-AIC(mod)
  BIC<-BIC(mod)
  
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  geno_name= unique(subset_geno_trt$GENO_NAME)
  rep =  unique(subset_geno_trt$REPETITION)
  
  write.table(t(c(i,
                  geno_name,
                  rep, 
                  df_summary$coefficients[1,1], 
                 df_summary$r.squared, 
                 df_summary$adj.r.squared,
                 AIC, 
                 BIC,
                 RMSE,
                 model_name )), 
              file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE)
  # print(i) 
  }
 }
files_int <- paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )

coef_intercept_geno <- do.call(rbind, lapply(files_int, read.table, sep = ",", fill = TRUE, header = TRUE))
coef_intercept_geno=na.omit(coef_intercept_geno)


```

#### extract the slopes and bkpt for segmented model

```{r model bkpt TR_ETREF_KC, message=FALSE}
####" Breakpoint model
model_name = "breakpoint_TR_ETREF_KC"

############ REP 1

outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep1_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep1_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 1)  
  

  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  # print(i) 
  
} else {
  message(" segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  

  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  
  
  
############ REP 2


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep2_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)


na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep2_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 2)  
  

  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  # print(i) 
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


############ REP 3
outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep3_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep3_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)
header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)





for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 3)  
  

  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  # print(i) 
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  




############ REP 4


outputfile<-paste0( opPATH.obj,trait_name, "_", model_name, "_geno_rep4_", trial, ".txt" )
  if (file.exists(outputfile)) file.remove(outputfile)
header = c("N_GENO", "GENO_NAME", "REPETITION", "SLOPE_X","BKPT" ,"SLOPE_X2", "R2", "R2adj", "AIC",  "BIC", "RMSE","model")
write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



na_log_file <-paste0( opPATH.obj,"NA_list_", model_name, "_rep4_", trial, ".txt")
   if (file.exists(na_log_file)) file.remove(na_log_file)

header_NAfile = c("N_GENO", "REPETITION")
write.table(t(header_NAfile), file=na_log_file, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



for (i in levels(factor(data.RmOut$N_GENO))){
    subset_geno <- data.RmOut %>% 
    dplyr::filter(data.RmOut$N_GENO == i)  
subset_geno_trt= subset_geno  %>% 
    dplyr::filter(subset_geno$REPETITION == 4)  
  

  x <- subset_geno_trt$ETREF_KC
  y <- subset_geno_trt$TR_G_H
  p <- NULL
  try(p <- lm(y~x),silent=TRUE)
  l <- NULL
  mod<-try(l <- segmented(p, seg.Z =~x),silent=T)
  
# Only proceed if segmented succeeded
if (!inherits(mod, "try-error")) {
  
  df_summary <- summary(mod)
  rep        <- unique(subset_geno_trt$REPETITION)
  geno_name  <- unique(subset_geno_trt$GENO_NAME)
  
  # slopes
  slope_x  <- coef(mod)["x"]                       # before breakpoint
  slope_x2 <- coef(mod)["x"] + coef(mod)["U1.x"]   # after breakpoint
  
  # breakpoint
  bkpt     <- df_summary$psi[ , "Est."]
  
  # model fit metrics
  r2       <- df_summary$r.squared
  r2_adj   <- df_summary$adj.r.squared
  AIC_val  <- AIC(mod)
   BIC_val  <- BIC(mod)

    
  y_hat <- predict(mod)
  RMSE <- sqrt(mean((y - y_hat)^2))
  
  # write output
  write.table(
    t(c(i, geno_name, rep, slope_x, bkpt, slope_x2, r2, r2_adj, AIC_val, BIC_val, RMSE, model_name)),
    file = outputfile, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
  
  print(i)
  
} else {
  message("segmented model failed for GENO ", i)
  
  rep       <- unique(subset_geno_trt$REPETITION)
  geno_name <- unique(subset_geno_trt$GENO_NAME)
  
  # optional separate log of failures
  write.table(
    t(c(i, geno_name, rep)),
    file = na_log_file, sep = ",", quote = FALSE, col.names = FALSE, row.names = FALSE, append = TRUE
  )
}}
  


files_bkpt <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
coef_bkpt_geno <- do.call(rbind, lapply(files_bkpt, read.table, sep = ",", fill = TRUE, header= TRUE))
coef_bkpt_geno=na.omit(coef_bkpt_geno)
```

```{r merge all models  }
# "N_GENO"     "GENO_NAME"  "REPETITION" "SLOPE_X"    "BKPT"       "SLOPE_X2"   "R2"         "R2adj"      "AIC"        "model"  

colnames(coef_bkpt_geno)[colnames(coef_bkpt_geno) == "SLOPE_X"] <- "SLOPE" ## same colnames for slope to merge them o

# Find common column names
dfs <- list(coef_bkpt_geno, coef_intercept_geno)
com_col <- Reduce(intersect, lapply(dfs, colnames))
# Subset each DF to only common columns
dfs_common <- lapply(dfs, function(df) df[com_col])
# Now safely rbind
coef_geno_rep_model_TR_ETREF_KC <- do.call(rbind, dfs_common)

```

#### boxplot

```{r  }
coef_geno_rep_model_TR_ETREF_KC$model = as.factor(coef_geno_rep_model_TR_ETREF_KC$model)
nlevels(coef_geno_rep_model_TR_ETREF_KC$model)

coef_geno_rep_model_TR_ETREF_KC$AIC = as.numeric(coef_geno_rep_model_TR_ETREF_KC$AIC)
coef_geno_rep_model_TR_ETREF_KC$R2 = as.numeric(coef_geno_rep_model_TR_ETREF_KC$R2)

#boxplot to visualize difference in R and AIC among model in general
#AIC comparison
AIC_plot = ggplot(coef_geno_rep_model_TR_ETREF_KC, aes(x = model, y = AIC, fill = model)) + 
  geom_boxplot() +
  labs(title = "AIC by model Type", x = "model", y = "AIC") +
  theme_minimal()
print(AIC_plot)

#R² comparison
R2_plot =ggplot(coef_geno_rep_model_TR_ETREF_KC, aes(x = model, y = R2, fill = model)) + 
  geom_boxplot() +
  labs(title = "R² by model Type", x = "model", y = "R²") +
  theme_minimal()

print(R2_plot)

#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_AIC_TR_ETREF_KC_", trait_name, "_", trial ,".png"),
  plot = AIC_plot,
  width = 6,
  height = 4
)


#Save the plot
ggsave(
  filename = paste0(opPATH.fig, "boxplot_R2_TR_ETREF_KC_",  trait_name, "_", trial ,".png"),
  plot = R2_plot,
  width = 6,
  height = 4
)


```

#### AIC 

```{r   }
coef_geno_rep_model_TR_ETREF_KC$GENO_TRT = NA
coef_geno_rep_model_TR_ETREF_KC$GENO_TRT = paste(coef_geno_rep_model_TR_ETREF_KC$N_GENO, coef_geno_rep_model_TR_ETREF_KC$REPETITION, sep = "_")
coef_geno_rep_model_TR_ETREF_KC$GENO_TRT = as.factor(coef_geno_rep_model_TR_ETREF_KC$GENO_TRT)
save(coef_geno_rep_model_TR_ETREF_KC, file = paste0(opPATH.obj, "coef_geno_rep_model_TR_ETREF_KC.RData"))

  output <- paste(trial, trait_name, "best_model_AIC_TR_ETREF_KC", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)



 for ( i in levels(coef_geno_rep_model_TR_ETREF_KC$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TR_ETREF_KC[coef_geno_rep_model_TR_ETREF_KC$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele
 index_min <- which.min(subset$AIC) 
  row_min =  subset[index_min, ]
 
   write.table(row_min, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   # print(i)
  
 }


```

```{ }
best_model_AIC <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)
unique(best_model_AIC$model)
print(paste("best model AIC TR_ETREF_KC linear for (%) ",sum(best_model_AIC$model == "linear_TR_ETREF_KC")/nrow(best_model_AIC)*100))
print(paste("best model AIC TR_ETREF_KC breakpoint for (%) ",sum(best_model_AIC$model == "breakpoint_TR_ETREF_KC")/nrow(best_model_AIC)*100))


```


#### R2 

```{r }
  output <- paste(trial, trait_name, "best_model_R2_TR_ETREF_KC", sep = "_")
  outputfile <- paste0(opPATH.obj,output, ".txt")

  if (file.exists(outputfile)) file.remove(outputfile)

header = paste(c(com_col, "GENO_TRT"))

# Write header once per file
  write.table(t(header), file=outputfile, sep=",", quote=FALSE,
              col.names=FALSE, row.names=FALSE, append=TRUE)

for ( i in levels(coef_geno_rep_model_TR_ETREF_KC$GENO_TRT) ) {  ## for each pot 
  subset<-coef_geno_rep_model_TR_ETREF_KC[coef_geno_rep_model_TR_ETREF_KC$GENO_TRT %in% c(i), ] ###1 df per genotype containing 4 rows, 1 per modele

 index_max <- which.max(subset$R2) ## find rownameswith max value R2
  row_max =  subset[index_max, ]
  
  
   write.table(row_max, file=outputfile, sep=",", quote=FALSE, col.names=F, row.names=F, append=TRUE) ####
   # print(i)
   
}
  
 
```

```{r }
best_model_R2 <- read.table(outputfile, sep = ",", header = TRUE, fill = TRUE, stringsAsFactors = FALSE)

print(paste("best model R2 TR_ETREF_KClinear for (%) ",sum(best_model_R2$model == "linear_TR_ETREF_KC")/nrow(best_model_R2)*100))
print(paste("best model R2 TR_ETREF_KC breakpoint for (%) ",sum(best_model_R2$model == "breakpoint_TR_ETREF_KC")/nrow(best_model_R2)*100))

```
#### plot model 

```{r plot models TR- ETREF_KC}


rep_colors <- c(
  "1" = "#A65E00",
  "2" = "#1C64A6",
  "3" = "#006747",
  "4" = "#7A2E00"
)


path = paste0("./figures/TR_ETREF_KC_models/", trial, "/")

opPATH.plot_TR= path
  if (!dir.exists(opPATH.plot_TR)) dir.create(opPATH.plot_TR, recursive = TRUE)

data$N_GENO = as.factor(data$N_GENO)

for (i in levels(data$N_GENO)) {

  subset <- data %>% filter(N_GENO == i)
  geno_name <- subset$GENO_NAME[1]

  # Keep only repetitions with ≥ 3 complete cases
  valid_reps <- subset %>%
    group_by(REPETITION) %>%
    filter(sum(!is.na(TR_G_H) & !is.na(ETREF_KC)) >= 3) %>%
    pull(REPETITION) %>%
    unique()

  subset <- subset %>% filter(REPETITION %in% valid_reps)
  subset$REPETITION <- factor(subset$REPETITION)

  if ((length(valid_reps) > 0) == TRUE) {

  ### -----------------------
  ### 1. Linear model (intercept = 0)
  ### -----------------------

  
# prep labels
label_lin <- subset %>%
group_by(REPETITION) %>%
reframe({
  mod <- lm(TR_G_H ~ 0 + ETREF_KC, data = cur_data())
  slope <- as.numeric(coef(mod)[["ETREF_KC"]])
  r2_val <- summary(mod)$r.squared
# 
  eq <- paste0("y = ", format(slope, scientific = TRUE, digits = 3), " * x")
  
  tibble(
    REPETITION = cur_group()$REPETITION[[1]],
    slope = slope,
    intercept = 0,
    eq = eq,
    r2 = round(r2_val, 2)
  )
}) %>%
ungroup() %>%
arrange(REPETITION) %>%
mutate(
  # Position de base en haut à gauche
  x_base = 0,
  y_top = max(subset$TR_G_H) * 1.05,
  y_bottom = y_top - 0.2 * (y_top - min(subset$TR_G_H)),
  # répartir verticalement du haut vers le bas
  y_label = y_top - (row_number() - 1) * (y_top - y_bottom) / (n() - 1),
  # petit décalage horizontal pour chaque répétition
  x_label = x_base + (row_number() - 1) * 0.05 * (max(subset$ETREF_KC) - min(subset$ETREF_KC))
)


# ### Graphique : points, régression, droite prolongée, labels fixes en haut à gauche
p1 <- ggplot(subset, aes(x = ETREF_KC, y = TR_G_H, color = REPETITION)) +
geom_point() +
# 
# régression locale
geom_smooth(method = "lm", formula = y ~ 0 + x, se = FALSE, linewidth = 1) +
# 
# droite prolongée en pointillé
geom_abline(
  data = label_lin,
  aes(slope = slope, intercept = intercept, color = REPETITION),
  linetype = "dashed",
  linewidth = 0.8,
  inherit.aes = FALSE
) +
# 
# labels équations + R² avec léger décalage
geom_text(
  data = label_lin,
  aes(x = x_label, y = y_label, label = paste0(eq, " R² = ", r2), color = REPETITION),
  hjust = 0,  # aligné à gauche
  vjust = 1,  # aligné vers le haut
  size = 4,
  show.legend = FALSE,
  inherit.aes = FALSE
) +
# 
scale_color_manual(values = rep_colors) +
labs(
  title = paste0("Linear model (intercept = 0) - Genotype ", i, " - ", geno_name),
  x = "ETREF_KC (mm.day⁻¹.kPa)",
  y = "Tr (g·h⁻¹)",
  color = "Repetition"
) +
theme_bw(base_size = 14) +
# 
# axe x commence à 0
coord_cartesian(xlim = c(0, NA))


}
# ### -----------------------
#     ### 2. Segmented (breakpoint) model
#  # ---------------------------
 all_bp_data <- data.frame()
 annotations <- data.frame(REPETITION = factor(),
                         label = character(),
                           x = numeric(),
                           y = numeric(),
                           stringsAsFactors = FALSE)
 
 # ---------------------------
# # Boucle sur chaque répétition
# # ---------------------------

  for (rep in unique(subset$REPETITION)) {
  subset_rep <- subset %>% filter(REPETITION == rep)
  subset_rep$ETREF_KC <- as.numeric(subset_rep$ETREF_KC)

 
  bp_model <- tryCatch({
    lm_base <- lm(TR_G_H ~ ETREF_KC, data = subset_rep)
    segmented(lm_base, seg.Z = ~ ETREF_KC,
              psi = list(ETREF_KC = median(subset_rep$ETREF_KC, na.rm = TRUE)))
  }, error = function(e) NULL)
  
  
  if (!is.null(bp_model)) {
#     # Générer les prédictions
    bp_data <- tryCatch({
      data.frame(ETREF_KC = seq(min(subset_rep$ETREF_KC),
                                max(subset_rep$ETREF_KC),
                                length.out = 100)) %>%
        mutate(TR_G_H = predict(bp_model, newdata = .),
               REPETITION = rep)
    }, error = function(e) NULL)

    if (!is.null(bp_data)) all_bp_data <- rbind(all_bp_data, bp_data)

  #  Récupérer les pentes et breakpoint
    slope_vals <- tryCatch(slope(bp_model)$ETREF_KC, error = function(e) NULL)
    if (!is.null(slope_vals) && length(slope_vals) >= 2) {
      slope1 <- format(slope_vals[1], scientific = TRUE, digits = 3)
      slope2 <- format(slope_vals[2], scientific = TRUE, digits = 3)
      psi <- format(bp_model$psi[2], scientific = FALSE, digits = 3)
      r2_bp <- round(summary(bp_model)$r.squared, 2)

     # Ajouter annotation
      annotations <- rbind(annotations, data.frame(
        REPETITION = rep,
        label = paste0("S1=", slope1, ", S2=", slope2,
                       ", Psi=", psi, ", R²=", r2_bp),
        stringsAsFactors = FALSE
      ))
    }
  }
}
     
# ---------------------------
# # Harmoniser les facteurs et espacer verticalement
# # ---------------------------
annotations$REPETITION <- factor(annotations$REPETITION, levels = levels(subset$REPETITION))


n_rep <- nrow(annotations)
if (n_rep > 0) {
 y_base <- max(subset$TR_G_H) * 1.05  
y_spacing <- 0.05 * (max(subset$TR_G_H) - min(subset$TR_G_H))  


annotations <- annotations %>%
  arrange(REPETITION) %>%
  mutate(
    x = max(subset$ETREF_KC) * 1.05,
    y = y_base - (row_number() - 1) * y_spacing
  )
} else {
  annotations <- data.frame(
    REPETITION = subset$REPETITION[1],
    label = "Segmented models failed",
    x = max(subset$ETREF_KC) * 1.05,
    y = max(subset$TR_G_H),
    stringsAsFactors = FALSE
  )
}
# 
# # ---------------------------
# # Création du graphique
# # ---------------------------
if (nrow(all_bp_data) > 0) {
  p2 <- ggplot(subset, aes(x = ETREF_KC, y = TR_G_H, color = REPETITION)) +
    geom_point() +
    geom_line(data = all_bp_data,
              aes(x = ETREF_KC, y = TR_G_H, group = REPETITION, color = REPETITION),
              size = 1) +
    geom_text(data = annotations,
              aes(x = x, y = y, label = label, color = REPETITION),
              hjust = 1, vjust = 1, size = 3.5, show.legend = FALSE) +
    scale_color_manual(values = rep_colors) +
    labs(title = paste0("Segmented model - Genotype ", i," - ", geno_name),
      x = "ETREF_KC (mm.day⁻¹.kPa)",
    y = "Tr (g·h⁻¹)",      color = "Repetition") +
    theme_bw(base_size = 14)
} else {
#  fallback si tous les modèles échouent
  p2 <- ggplot() +
    annotate("text", x = 0.5, y = 0.5, label = "Segmented models failed", size = 5) +
    theme_void() +
    labs(title = paste0("Segmented (breakpoint) model - Genotype ", i, " - ", geno_name))
}


#  #  Combine plots
full_plot <- (p1 | p2)
# 
# Save combined plot
ggsave(filename = paste0(opPATH.plot_TR, "TR_ETREF_KC_models_", trial, "_GENO_", i, "_",geno_name, ".png"), plot = full_plot,
       width = 14, height = 10, dpi = 300)

}


```


### what is the most adapted model ? with Xvar (ETref, ETref*Kc, VPD), with Yvar (Tr or TRrate), and with regression rype (linear or segmented)

```{r }
### sum up 

model_name = "linear_TRrate_VPD"
files_linear_TRrate_VPD <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_linear_TRrate_VPD <- do.call(rbind, lapply(files_linear_TRrate_VPD, read.table, sep = ",", fill = TRUE, header= TRUE))

model_name = "linear_TRrate_ETREF"
files_linear_TRrate_ETREF <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_linear_TRrate_ETREF <- do.call(rbind, lapply(files_linear_TRrate_ETREF, read.table, sep = ",", fill = TRUE, header= TRUE))

model_name = "linear_TRrate_ETREF_KC"
files_linear_TRrate_ETREF_KC <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_linear_TRrate_ETREF_KC <- do.call(rbind, lapply(files_linear_TRrate_ETREF_KC, read.table, sep = ",", fill = TRUE, header= TRUE))

results_linear_TRrate_ETREF_KC$model <- gsub("ETREF_KC", "ETREF-KC", 
                                          results_linear_TRrate_ETREF_KC$model) ## _ va etre utiliser comme sep apres



model_name = "breakpoint_TRrate_VPD"
files_breakpoint_TRrate_VPD <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_breakpoint_TRrate_VPD <- do.call(rbind, lapply(files_breakpoint_TRrate_VPD, read.table, sep = ",", fill = TRUE, header= TRUE))

model_name = "breakpoint_TRrate_ETREF"
files_breakpoint_TRrate_ETREF <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_breakpoint_TRrate_ETREF <- do.call(rbind, lapply(files_breakpoint_TRrate_ETREF, read.table, sep = ",", fill = TRUE, header= TRUE))

model_name = "breakpoint_TRrate_ETREF_KC"
files_breakpoint_TRrate_ETREF_KC <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_breakpoint_TRrate_ETREF_KC <- do.call(rbind, lapply(files_breakpoint_TRrate_ETREF_KC, read.table, sep = ",", fill = TRUE, header= TRUE))


results_breakpoint_TRrate_ETREF_KC$model <- gsub("ETREF_KC", "ETREF-KC", 
                                          results_breakpoint_TRrate_ETREF_KC$model) ## _ va etre utiliser comme sep apres



model_name = "linear_TR_VPD"
files_linear_TR_VPD <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_linear_TR_VPD <- do.call(rbind, lapply(files_linear_TR_VPD, read.table, sep = ",", fill = TRUE, header= TRUE))

model_name = "linear_TR_ETREF"
files_linear_TR_ETREF <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_linear_TR_ETREF <- do.call(rbind, lapply(files_linear_TR_ETREF, read.table, sep = ",", fill = TRUE, header= TRUE))

model_name = "linear_TR_ETREF_KC"
files_linear_TR_ETREF_KC <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_linear_TR_ETREF_KC <- do.call(rbind, lapply(files_linear_TR_ETREF_KC, read.table, sep = ",", fill = TRUE, header= TRUE))


results_linear_TR_ETREF_KC$model <- gsub("ETREF_KC", "ETREF-KC", 
                                          results_linear_TR_ETREF_KC$model) ## _ va etre utiliser comme sep apres



model_name = "breakpoint_TR_VPD"
files_breakpoint_TR_VPD <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_breakpoint_TR_VPD <- do.call(rbind, lapply(files_breakpoint_TR_VPD, read.table, sep = ",", fill = TRUE, header= TRUE))

model_name = "breakpoint_TR_ETREF"
files_breakpoint_TR_ETREF <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_breakpoint_TR_ETREF <- do.call(rbind, lapply(files_breakpoint_TR_ETREF, read.table, sep = ",", fill = TRUE, header= TRUE))

model_name = "breakpoint_TR_ETREF_KC"
files_breakpoint_TR_ETREF_KC <- paste0(opPATH.obj, trait_name, "_", model_name, "_geno_rep", 1:4, "_", trial, ".txt" )
results_breakpoint_TR_ETREF_KC <- do.call(rbind, lapply(files_breakpoint_TR_ETREF_KC, read.table, sep = ",", fill = TRUE, header= TRUE))

results_breakpoint_TR_ETREF_KC$model <- gsub("ETREF_KC", "ETREF-KC", 
                                          results_breakpoint_TR_ETREF_KC$model)




bkpt = rbind( results_breakpoint_TR_ETREF, results_breakpoint_TR_ETREF_KC, results_breakpoint_TR_VPD, results_breakpoint_TRrate_ETREF, results_breakpoint_TRrate_ETREF_KC, results_breakpoint_TRrate_VPD)

colnames(bkpt)[colnames(bkpt) == "SLOPE_X"] <- "SLOPE"
bkpt = na.omit(bkpt) 

bkpt <- bkpt %>%
  mutate(model_original = model) %>%  
  separate_wider_delim(
    col = model,
    delim = "_",
    names_sep = "_part",
    too_few = "align_start"            # remplit avec NA si certaines lignes ont moins de parties
  )


lin = rbind(results_linear_TR_ETREF, results_linear_TR_ETREF_KC, results_linear_TR_VPD, results_linear_TRrate_ETREF, results_linear_TRrate_ETREF_KC, results_linear_TRrate_VPD)

lin <- lin %>%
  mutate(model_original = model) %>%   #
  separate_wider_delim(
    col = model,
    delim = "_",
    names_sep = "_part",
    too_few = "align_start"            # remplit avec NA si certaines lignes ont moins de parties
  )
lin = na.omit(lin) 

common_cols <- Reduce(intersect, list(names(bkpt), names(lin)))

# Garde uniquement les colonnes communes dans chacun
df_list <- list(
  bkpt[, common_cols],
  lin[, common_cols]
)

# Fusionne tout
df_merged <- do.call(rbind, df_list)

                                                          
final_results=  df_merged


sum(is.na(final_results$RMSE)) # no missing data 
sum(is.na(final_results$AIC)) # no missing data 

sum(is.na(final_results$BIC)) # no missing data 
sum(is.na(final_results$R2)) # no missing data 


colnames(final_results)[colnames(final_results) == "model_part1"] <- "regression"
colnames(final_results)[colnames(final_results) == "model_part2"] <- "Yvar"
colnames(final_results)[colnames(final_results) == "model_part3"] <- "Xvar"

final_results$regression = as.factor(final_results$regression )
final_results$Yvar = as.factor(final_results$Yvar )
final_results$Xvar = as.factor(final_results$Xvar )


final_results$AIC = as.numeric(final_results$AIC )
final_results$RMSE = as.numeric(final_results$RMSE )

levels(final_results$regression)
levels(final_results$Yvar)
levels(final_results$Xvar)

```

```{r}
sum_up_reg <- final_results %>%
  group_by(regression) %>%
  summarise(
    min_R2  = min(R2, na.rm = TRUE),
    max_R2  = max(R2, na.rm = TRUE),
    mean_R2 = mean(R2, na.rm = TRUE),
    median_AIC= median(AIC),
    median_RMSE = median(RMSE),
        .groups = "drop"
  ) %>%
  arrange(desc(mean_R2))
print(sum_up_reg)
## gloablly, higher R2 with linear regression  AIC 
```

```{r}
sum_up_Xvar <- final_results %>%
  group_by(Xvar) %>%
  summarise(
    min_R2  = min(R2, na.rm = TRUE),
    max_R2  = max(R2, na.rm = TRUE),
    mean_R2 = mean(R2, na.rm = TRUE),
 median_AIC= median(AIC),
    median_RMSE = median(RMSE, na.rm = TRUE),
        .groups = "drop"
  ) %>%
  arrange(desc(mean_R2))

print(sum_up_Xvar)
## gloablly, higher mean R2 with ETREF-KC  

```



```{r}
sum_up_XY <- final_results %>%
  group_by(Xvar, Yvar) %>%
  summarise(
    min_R2  = min(R2, na.rm = TRUE),
    max_R2  = max(R2, na.rm = TRUE),
    mean_R2 = mean(R2, na.rm = TRUE),
median_AIC= median(AIC),
    median_RMSE = median(RMSE),
        .groups = "drop"
  ) %>%
  arrange(desc(mean_R2))

# Afficher le tableau
print(sum_up_XY)




## globally ETREF-KC fitted with TR and TRrate 
```




```{r}
sum_up_XY_regression <- final_results %>%
  group_by(Xvar, Yvar, regression) %>%
  summarise(
    min_R2  = min(R2, na.rm = TRUE),
    max_R2  = max(R2, na.rm = TRUE),
    mean_R2 = mean(R2, na.rm = TRUE),
median_AIC= median(AIC),
    median_RMSE = median(RMSE),
        .groups = "drop"
  ) %>%
  arrange(desc(mean_R2))

# Afficher le tableau
print(sum_up_XY_regression)

```


```{r}
sum_up_XY_TRrate <- final_results %>%
  filter(Yvar == "TR") %>%
  group_by(Xvar, regression) %>%
  summarise(
    min_R2  = min(R2, na.rm = TRUE),
    max_R2  = max(R2, na.rm = TRUE),
    mean_R2 = mean(R2, na.rm = TRUE),
median_AIC= median(AIC),
    median_RMSE = median(RMSE),
        .groups = "drop"
  ) %>%
  arrange(desc(mean_R2))

# Afficher le tableau
print(sum_up_XY_TRrate)
```

```{r}

## Pourquoi la médiane est préférable ici : a) Robustesse aux outliers Certains plots peuvent donner des modèles pathologiques : pente quasi nulle, variance faible, ou même RMSE très grande si le plot contient peu de données. Ces plots extrêmes faussent la moyenne, mais ont peu d’importance biologique globale. La médiane résiste aux valeurs extrêmes et reflète la tendance centrale réelle.b) Distribution asymétrique : Tes plots ont des conditions très différentes : genotypes, répétitions, périodes. Les AIC ou RMSE ne sont pas symétriques : souvent, une petite fraction des plots a des valeurs très différentes → moyenne trompeuse. La médiane capture le comportement typique d’un plot. c) Interprétation biologique La médiane répond à : “Pour un plot typique, cette variable est la meilleure” La moyenne pourrait dire :“En moyenne sur tous les plots, y compris les plus atypiques, cette variable est la meilleure” Dans un contexte agronomique ou physiologique, la médiane correspond mieux au comportement du plot standard.
```



### continue the analysis with the select model 



```{r come back to coef }
# focus only linear with intecept = 0
##bind all slope of each reps of linear model  in only one file
trait_name = "SLOPE"
model_name = "linear"
Yvar= "TR" ## TRrate or TR
Xvar= "ETREF" ## VPD, ETREF, or ETREF_KC


files_lin = paste0( opPATH.obj,trait_name, "_", model_name, "_",Yvar, "_",Xvar,"_geno_rep", 1:4, "_", trial, ".txt" )
coef_intercept <- do.call(rbind, lapply(files_lin, function(f) {
  read.table(f, sep = ",", header = TRUE, stringsAsFactors = FALSE)
}))


coef_intercept$GENO_TRT= paste(coef_intercept$N_GENO, coef_intercept$REPETITION, sep = "_")
coef_intercept$N_GENO=as.factor(coef_intercept$N_GENO)
coef_intercept$GENO_TRT=as.factor(coef_intercept$GENO_TRT)
coef_intercept$SLOPE=as.numeric(coef_intercept$SLOPE)
 

outputfile =  paste0(opPATH.results, "coef_intercept_raw_", Yvar, "_", Xvar, "_", trial, ".csv")
  if (file.exists(outputfile)) file.remove(outputfile)


```

```{r merge with metadata block rep thanks to geno trt  }
## add metadata on slope data )

metad =  transp[, c("COLUMN", "ROW", "BLOCK", "GENO_TRT", "Variety_ID")]
metad =  metad[!duplicated(metad), ]
nrow(metad)


coef_intercept_metad = merge(x=coef_intercept, y=metad, by = "GENO_TRT")

coef_intercept_metad <- distinct(coef_intercept_metad, GENO_TRT, .keep_all = TRUE)



head(coef_intercept_metad$N_GENO)
head(coef_intercept_metad$REPETITION)
head(coef_intercept_metad$BLOCK)

coef_intercept_metad = na.omit(coef_intercept_metad)

coef_intercept_metad$N_GENO=as.factor(coef_intercept_metad$N_GENO)
coef_intercept_metad$REPETITION=as.factor(coef_intercept_metad$REPETITION) 
coef_intercept_metad$ROW=as.factor(coef_intercept_metad$ROW) 

coef_intercept_metad$BLOCK=as.factor(coef_intercept_metad$BLOCK)
```




### visualisation slope values among repetition and block

```{r }
### boxplot to visualize variability among repetitions / BLOCK /  ... 
ggplot(coef_intercept_metad, aes(x= coef_intercept_metad$REPETITION, y=coef_intercept_metad$SLOPE)) + 
  geom_boxplot()

ggplot(coef_intercept_metad, aes(x= coef_intercept_metad$BLOCK, y=coef_intercept_metad$SLOPE)) + 
  geom_boxplot()

ggplot(coef_intercept_metad, aes(x= coef_intercept_metad$COLUMN, y=coef_intercept_metad$SLOPE)) + 
  geom_boxplot()

ggplot(coef_intercept_metad, aes(x= coef_intercept_metad$SLOPE, y=coef_intercept_metad$SLOPE)) + 
  geom_boxplot()
ggplot(coef_intercept_metad, aes(x= coef_intercept_metad$ROW, y=coef_intercept_metad$SLOPE)) + 
  geom_boxplot()

```

```{r outleirs sorting }
ount_before = nrow(coef_intercept_metad)

    out <- boxplot(coef_intercept_metad$SLOPE, plot = FALSE)$out # values to remove
    tf <- which(coef_intercept_metad$SLOPE %in% out) # position in the list
    coef_intercept_metad$SLOPE[tf] <- NA
    

coef_intercept_metad = na.omit(coef_intercept_metad)
    
count_after = nrow(coef_intercept_metad)

out_tot = count_before - count_after


paste0("still ", nrow(coef_intercept_metad ), " observations on ",  nlevels(coef_intercept_metad $N_GENO), " genotypes ", out_tot, " outliers removed")

```




```{r }
### boxplot to visualize variability among repetitions / BLOCK /  ... 
ggplot(coef_intercept_metad, aes(x= coef_intercept_metad$REPETITION, y=coef_intercept_metad$SLOPE)) + 
  geom_boxplot()

ggplot(coef_intercept_metad, aes(x= coef_intercept_metad$BLOCK, y=coef_intercept_metad$SLOPE)) + 
  geom_boxplot()


ggplot(coef_intercept_metad, aes(x= coef_intercept_metad$COLUMN, y=coef_intercept_metad$SLOPE)) + 
  geom_boxplot()

ggplot(coef_intercept_metad, aes(x= coef_intercept_metad$SLOPE, y=coef_intercept_metad$SLOPE)) + 
  geom_boxplot()
ggplot(coef_intercept_metad, aes(x= coef_intercept_metad$ROW, y=coef_intercept_metad$SLOPE)) + 
  geom_boxplot()

```


```{r histogram raw data slope  }

#Clean  data (remove NAs)
slope_values <- na.omit(coef_intercept_metad$SLOPE)
df <- data.frame(SLOPE = slope_values)
mean_slope <- mean(slope_values)
sd_slope <- sd(slope_values)

#Create histogram with normal curve using ggplot2
p <- ggplot(df, aes(x = SLOPE)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "lightblue", color = "black") +
  stat_function(fun = dnorm, args = list(mean = mean_slope, sd = sd_slope), color = "darkred", size = 1.2) +
  labs(
    title = paste ("Histogram of ", trait_name, Yvar, "~", Xvar,  trial ),
    x = "Slope y=ax",
    y = "Density"
  ) +
  theme_minimal()

print(p)


# Save the plot
ggsave(
  filename = paste0(opPATH.fig, "HIST_", trait_name, "_", Yvar, "_", Xvar, "_", trial, ".png"),
  plot = p,
  width = 6,
  height = 4
)

```


```{r}
min(coef_intercept_metad$R2)
max(coef_intercept_metad$R2)
mean(coef_intercept_metad$R2)

min_geno <- coef_intercept_metad$N_GENO[which.min(coef_intercept_metad$R2)]
max_geno <- coef_intercept_metad$N_GENO[which.max(coef_intercept_metad$R2)]
min_geno
max_geno
```

```{r anova among block rep}
model<-lm(SLOPE~REPETITION, data = coef_intercept_metad)
aov<-Anova(model)
print(aov)

model<-lm(SLOPE~BLOCK, data = coef_intercept_metad)
aov<-Anova(model)
print(aov)

model<-lm(SLOPE~COLUMN, data = coef_intercept_metad)
aov<-aov(model)
print(aov)

model<-lm(SLOPE~ROW, data = coef_intercept_metad)
aov<-aov(model)
print(aov)

```
 
 
 
 
```{r output }

write.table(x=coef_intercept_metad, file= paste0(opPATH.results, "slope_values_cleaned_", Yvar, "_", Xvar, "_", trial, ".csv"), col.names = TRUE, row.names = FALSE, sep = ";")
```




### description variable slope coefficient 

```{r descriptive stat, echo = FALSE}
df_desc = as.data.frame(stat.desc(x=coef_intercept_metad$SLOPE))

library(knitr)
# Generate the table
tab <- kable(df_desc, caption = paste("descriptive statistics", trial))

print(df_desc)
```



```{r anova among geno }
model_slope <- lmer(SLOPE ~ 1 + (1 | N_GENO) + (1 | BLOCK)+ (1 | REPETITION) , data = coef_intercept_metad)
print(model_slope)

```



```{r }
model_slope_reduced <- lmer(SLOPE ~ 1  + (1 | BLOCK)+ (1 | REPETITION), data = coef_intercept_metad)
print(model_slope_reduced)

```
```{r }
aov= anova(model_slope_reduced, model_slope)
print(aov)
```

```{r heritability}

# --- Run H2cal analysis ---
coef_intercept_metad$REPETITION = as.factor(coef_intercept_metad$REPETITION)
coef_intercept_metad$BLOCK = as.factor(coef_intercept_metad$BLOCK)
# 

## -------------------------------
## Mixed model
## -------------------------------



# https://excellenceinbreeding.org/sites/default/files/manual/Heritability_22-06-2021.pdf
## --> cullis recommanded : "Cullis et al. (2006) propose a modern method that is widely used to account for the unbalanced scenario that plant breeders face in the single and multi-environment context with the advantage of not requiring every entry to have one rep. In this case, the genetic term is fitted as a random effect (BLUP). It uses the square of the standard error of the genetic estimates (across environments) to attain an approximation of the non-genetic variation (Figure 2). The formula is as follows: H²= 1- (average standard error of the genotypic BLUPs)/ (2*  σ² genotype )

library(agriutilities)
H2_cullis <- h_cullis(model_slope, genotype = "N_GENO", re_MME = FALSE)

print(H2_cullis)
save(H2_cullis, file =  paste0(opPATH.obj,"heritability_cullis_",trait_name,"_", Yvar, "_", Xvar, "_", trial, ".RData"))
write.table(H2_cullis, file = paste0(opPATH.results,"heritability_cullis",trait_name,"_", Yvar, "_", Xvar, "_", trial, ".csv"), dec = ".", sep = ";")
```


```{r blups}
blup_geno <- ranef(model_slope)$N_GENO ## save blup

blup_result <-  blup_geno %>%
  tibble::rownames_to_column("N_GENO") %>% ## add n_geno id 
  rename(BLUP = `(Intercept)`)

  
  head(blup_result)

save(blup_result, file =  paste0(opPATH.obj,"BLUPS_",trait_name,"_", Yvar, "_", Xvar, "_", trial, ".RData"))  
write.table(blup_result, file = paste0(opPATH.results,"BLUPS_",trait_name,"_", Yvar, "_", Xvar, "_", trial, ".csv"), dec = ".", sep = ";")
```


# mean per genotype :


```{r mean per geno}

SLOPE_mean<-as.data.frame(with(coef_intercept_metad, tapply(coef_intercept_metad$SLOPE, N_GENO, mean)))
SLOPE_mean = cbind(rownames(SLOPE_mean), SLOPE_mean[,1])
colnames(SLOPE_mean) = c("N_GENO", "SLOPE")
panel = read.csv(paste0(opPATH.data,"panel_sorghum.csv"), sep = ";", header = TRUE)

SLOPE_mean = merge(SLOPE_mean, panel, by= "N_GENO")
write.table(SLOPE_mean, file = paste0(opPATH.results,trait_name, "_mean_","_", Yvar, "_", Xvar, "_", trial, ".csv"), dec = ".", sep = ";", row.names = FALSE)

```


